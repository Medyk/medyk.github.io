{"config":{"indexing":"full","lang":["en"],"min_search_length":2,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Nerdoza Studio 2025.06.29 - Proxmox Fix 2025.05.09 - Synology DS414 \u2192 TrueNAS 2024.05.17 - Factorio Stats 2024.04.27 - Factorio Faceless Headless Server 2022.12.25 - SSH Certificates 2022.11.12 - Wireguard","title":"Nerdoza Studio"},{"location":"#nerdoza-studio","text":"2025.06.29 - Proxmox Fix 2025.05.09 - Synology DS414 \u2192 TrueNAS 2024.05.17 - Factorio Stats 2024.04.27 - Factorio Faceless Headless Server 2022.12.25 - SSH Certificates 2022.11.12 - Wireguard","title":"Nerdoza Studio"},{"location":"2022-11-12-wireguard/","text":"2022.11.12 - Wireguard Intro Przetestowa\u0142em konfiguracj\u0119 WireGuard\u2019a z moj\u0105 aktualn\u0105 sieci\u0105 (UPC w domu, njumobile w pracowni - dodatkowe NATowanie po stronie Orange, wi\u0119c brak mo\u017cliwo\u015bci wystawienia czegokolwiek na \u015bwiat) Przyj\u0119ta adresacja # Sie\u0107 Si\u0119\u0107 domowa - 192.168.0.0/24 Sie\u0107 pracowni - 192.168.3.0/24 Sie\u0107 WireGuard - 172.27.0.0/24 # Hosty UPC - 192.168.0.1 Komp - 192.168.0.7 RPI2 - 192.168.0.9 / 172.27.0.4 pfSense - 192.168.3.1 / 172.27.0.3 RandomServer - 192.168.3.253 Konfiguracja RasperryPi Instalacja WireGuard na RPi2 jest prosta bo idzie z pakiet\u00f3w $ apt install raspberrypi-kernel-headers $ apt-get install wireguard wireguard-tools Po instalacji trzeba zrestartowa\u0107 Pi sudo reboot (przynajmniej tak by\u0142o w moim przypadku) Po restarcie dodanie nowego interfejsu powinno zadzia\u0142a\u0107 $ ip link add dev wg0 type wireguard Konfiguracj\u0119 najlepiej zrobi\u0107 toolsami ( wg albo wg-quick ) $ wg --help Usage: wg <cmd> [<args>] Available subcommands: show: Shows the current configuration and device information showconf: Shows the current configuration of a given WireGuard interface, for use with `setconf` set: Change the current configuration, add peers, remove peers, or change peers setconf: Applies a configuration file to a WireGuard interface addconf: Appends a configuration file to a WireGuard interface syncconf: Synchronizes a configuration file to a WireGuard interface genkey: Generates a new private key and writes it to stdout genpsk: Generates a new preshared key and writes it to stdout pubkey: Reads a private key from stdin and writes a public key to stdout Dokumentacja opisuj\u0105ca struktur\u0119 pliku conf jest pod linkiem https://git.zx2c4.com/wireguard-tools/about/src/man/wg-quick.8 ( wg-quick ma wi\u0119cej opcji w conf ni\u017c wg - jest komenda wg-quick strip ) Generowanie kluczy prywatnych i publicznych $ wg genkey > private $ wg pubkey < private Utworzy\u0142em plik w /etc/wireguard/wg0.conf dla wg-quick # home network [Interface] Address = 172.27.0.4/24 MTU = 1400 FwMark = 0x7767 PrivateKey = <server-private-key> ListenPort = 51820 # workshop network [Peer] PublicKey = <client-public-key> PresharedKey = <client-preshared-key> AllowedIPs = 172.27.0.0/24,192.168.3.0/24 PersistentKeepalive = 25 Keepalive jest potrzebny do utrzymania NATu po stronie njumobile Uruchomienie tunelu $ wg-quick up wg0 Aktualizacja ustawie\u0144 $ wg syncconf wg0 <(wg-quick strip wg0) Na routerze UPC dorzucony port-forwarding. Konfiguracja pfSense Trzeba doinstalowa\u0107 pakiet Nast\u0119pnie dodajemy tunel Przypisujemy interfejs (u mnie OPT2 ) Ustawiamy IP (u mnie 172.27.0.3/24 ) Dodatkowo MTU ustawi\u0142em na 1400 - info w necie https://gist.github.com/nitred/f16850ca48c48c79bf422e90ee5b9d95 Tworzymy regu\u0142y FW - nie wiem czy potrzeba ale doda\u0142em takie same regu\u0142y dla OPT2 Dodajemy Gateway Oraz tras\u0119 statyczn\u0105 do mojego kompa Na ko\u0144cu doda\u0142em Peer\u2019a dla WG z dozwolonymi sieciami Po chwili pracownia pod\u0142\u0105czy\u0142a si\u0119 do sieci domowej Status po stronie PIVPN $ wg interface: wg0 public key: <cut> private key: (hidden) listening port: <cut> fwmark: 0x7767 peer: <cut> preshared key: (hidden) endpoint: <cut> allowed ips: 172.27.0.0/24, 192.168.3.0/24 latest handshake: 1 minute, 26 seconds ago transfer: 22.35 MiB received, 8.16 MiB sent persistent keepalive: every 25 seconds Test po\u0142\u0105czenia Na PIVPN doda\u0142em tras\u0119 do jednego hosta $ sudo route add -host 192.168.3.253 metric 0 dev wg0 $ route Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface ... 192.168.3.253 0.0.0.0 255.255.255.255 UH 0 0 0 wg0 ... Na komputerze domowym doda\u0142em route\u2019a via RPi PS> route -p ADD 172.27.0.0 MASK 255.255.255.0 192.168.0.9 METRIC 95 Z sieci domowej wida\u0107 hosta WG po stronie pracowni # komputer domowy PS> ping 172.27.0.3 Pinging 172.27.0.3 with 32 bytes of data: Reply from 172.27.0.3: bytes=32 time=64ms TTL=63 Reply from 172.27.0.3: bytes=32 time=63ms TTL=63 Reply from 172.27.0.3: bytes=32 time=59ms TTL=63 Reply from 172.27.0.3: bytes=32 time=72ms TTL=63 Ping statistics for 172.27.0.3: Packets: Sent = 4, Received = 4, Lost = 0 (0% loss), Approximate round trip times in milli-seconds: Minimum = 59ms, Maximum = 72ms, Average = 64ms Pingowanie i wej\u015bcie na HTTPS odk\u0142ada si\u0119 do log\u00f3w prawid\u0142owo Komunikacja z PIVPN te\u017c wygl\u0105da dobrze # pivpn root@pivpn:~# traceroute -4 -T 192.168.3.253 traceroute to 192.168.3.253 (192.168.3.253), 30 hops max, 60 byte packets 1 172.27.0.3 (172.27.0.3) 158.550 ms 158.371 ms 166.330 ms 2 192.168.3.253 (192.168.3.253) 166.135 ms 165.975 ms 166.307 ms root@pivpn:~# traceroute -4 -T -i wg0 192.168.3.253 traceroute to 192.168.3.253 (192.168.3.253), 30 hops max, 60 byte packets 1 172.27.0.3 (172.27.0.3) 59.417 ms 66.819 ms 72.106 ms 2 192.168.3.253 (192.168.3.253) 71.728 ms 71.502 ms 71.789 ms root@pivpn:~# traceroute -4 -T -i tun0 192.168.3.253 traceroute to 192.168.3.253 (192.168.3.253), 30 hops max, 60 byte packets 1 10.15.5.2 (10.15.5.2) 59.213 ms 66.880 ms 66.885 ms 2 192.168.3.253 (192.168.3.253) 66.944 ms 68.757 ms 68.930 ms Czy dzia\u0142a niezawodnie dowiem si\u0119 jak wy\u0142\u0105cz\u0119 ovpn \ud83d\ude00 Linki https://www.wireguard.com/quickstart/ https://www.howtogeek.com/657780/how-to-use-the-traceroute-command-on-linux/ https://www.howtogeek.com/howto/windows/adding-a-tcpip-route-to-the-windows-routing-table/ https://git.zx2c4.com/wireguard-tools/about/src/man/wg.8 https://git.zx2c4.com/wireguard-tools/about/src/man/wg-quick.8","title":"2022.11.12 - Wireguard"},{"location":"2022-11-12-wireguard/#20221112-wireguard","text":"","title":"2022.11.12 - Wireguard"},{"location":"2022-11-12-wireguard/#intro","text":"Przetestowa\u0142em konfiguracj\u0119 WireGuard\u2019a z moj\u0105 aktualn\u0105 sieci\u0105 (UPC w domu, njumobile w pracowni - dodatkowe NATowanie po stronie Orange, wi\u0119c brak mo\u017cliwo\u015bci wystawienia czegokolwiek na \u015bwiat) Przyj\u0119ta adresacja # Sie\u0107 Si\u0119\u0107 domowa - 192.168.0.0/24 Sie\u0107 pracowni - 192.168.3.0/24 Sie\u0107 WireGuard - 172.27.0.0/24 # Hosty UPC - 192.168.0.1 Komp - 192.168.0.7 RPI2 - 192.168.0.9 / 172.27.0.4 pfSense - 192.168.3.1 / 172.27.0.3 RandomServer - 192.168.3.253","title":"Intro"},{"location":"2022-11-12-wireguard/#konfiguracja-rasperrypi","text":"Instalacja WireGuard na RPi2 jest prosta bo idzie z pakiet\u00f3w $ apt install raspberrypi-kernel-headers $ apt-get install wireguard wireguard-tools Po instalacji trzeba zrestartowa\u0107 Pi sudo reboot (przynajmniej tak by\u0142o w moim przypadku) Po restarcie dodanie nowego interfejsu powinno zadzia\u0142a\u0107 $ ip link add dev wg0 type wireguard Konfiguracj\u0119 najlepiej zrobi\u0107 toolsami ( wg albo wg-quick ) $ wg --help Usage: wg <cmd> [<args>] Available subcommands: show: Shows the current configuration and device information showconf: Shows the current configuration of a given WireGuard interface, for use with `setconf` set: Change the current configuration, add peers, remove peers, or change peers setconf: Applies a configuration file to a WireGuard interface addconf: Appends a configuration file to a WireGuard interface syncconf: Synchronizes a configuration file to a WireGuard interface genkey: Generates a new private key and writes it to stdout genpsk: Generates a new preshared key and writes it to stdout pubkey: Reads a private key from stdin and writes a public key to stdout Dokumentacja opisuj\u0105ca struktur\u0119 pliku conf jest pod linkiem https://git.zx2c4.com/wireguard-tools/about/src/man/wg-quick.8 ( wg-quick ma wi\u0119cej opcji w conf ni\u017c wg - jest komenda wg-quick strip ) Generowanie kluczy prywatnych i publicznych $ wg genkey > private $ wg pubkey < private Utworzy\u0142em plik w /etc/wireguard/wg0.conf dla wg-quick # home network [Interface] Address = 172.27.0.4/24 MTU = 1400 FwMark = 0x7767 PrivateKey = <server-private-key> ListenPort = 51820 # workshop network [Peer] PublicKey = <client-public-key> PresharedKey = <client-preshared-key> AllowedIPs = 172.27.0.0/24,192.168.3.0/24 PersistentKeepalive = 25 Keepalive jest potrzebny do utrzymania NATu po stronie njumobile Uruchomienie tunelu $ wg-quick up wg0 Aktualizacja ustawie\u0144 $ wg syncconf wg0 <(wg-quick strip wg0) Na routerze UPC dorzucony port-forwarding.","title":"Konfiguracja RasperryPi"},{"location":"2022-11-12-wireguard/#konfiguracja-pfsense","text":"Trzeba doinstalowa\u0107 pakiet Nast\u0119pnie dodajemy tunel Przypisujemy interfejs (u mnie OPT2 ) Ustawiamy IP (u mnie 172.27.0.3/24 ) Dodatkowo MTU ustawi\u0142em na 1400 - info w necie https://gist.github.com/nitred/f16850ca48c48c79bf422e90ee5b9d95 Tworzymy regu\u0142y FW - nie wiem czy potrzeba ale doda\u0142em takie same regu\u0142y dla OPT2 Dodajemy Gateway Oraz tras\u0119 statyczn\u0105 do mojego kompa Na ko\u0144cu doda\u0142em Peer\u2019a dla WG z dozwolonymi sieciami Po chwili pracownia pod\u0142\u0105czy\u0142a si\u0119 do sieci domowej Status po stronie PIVPN $ wg interface: wg0 public key: <cut> private key: (hidden) listening port: <cut> fwmark: 0x7767 peer: <cut> preshared key: (hidden) endpoint: <cut> allowed ips: 172.27.0.0/24, 192.168.3.0/24 latest handshake: 1 minute, 26 seconds ago transfer: 22.35 MiB received, 8.16 MiB sent persistent keepalive: every 25 seconds","title":"Konfiguracja pfSense"},{"location":"2022-11-12-wireguard/#test-poaczenia","text":"Na PIVPN doda\u0142em tras\u0119 do jednego hosta $ sudo route add -host 192.168.3.253 metric 0 dev wg0 $ route Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface ... 192.168.3.253 0.0.0.0 255.255.255.255 UH 0 0 0 wg0 ... Na komputerze domowym doda\u0142em route\u2019a via RPi PS> route -p ADD 172.27.0.0 MASK 255.255.255.0 192.168.0.9 METRIC 95 Z sieci domowej wida\u0107 hosta WG po stronie pracowni # komputer domowy PS> ping 172.27.0.3 Pinging 172.27.0.3 with 32 bytes of data: Reply from 172.27.0.3: bytes=32 time=64ms TTL=63 Reply from 172.27.0.3: bytes=32 time=63ms TTL=63 Reply from 172.27.0.3: bytes=32 time=59ms TTL=63 Reply from 172.27.0.3: bytes=32 time=72ms TTL=63 Ping statistics for 172.27.0.3: Packets: Sent = 4, Received = 4, Lost = 0 (0% loss), Approximate round trip times in milli-seconds: Minimum = 59ms, Maximum = 72ms, Average = 64ms Pingowanie i wej\u015bcie na HTTPS odk\u0142ada si\u0119 do log\u00f3w prawid\u0142owo Komunikacja z PIVPN te\u017c wygl\u0105da dobrze # pivpn root@pivpn:~# traceroute -4 -T 192.168.3.253 traceroute to 192.168.3.253 (192.168.3.253), 30 hops max, 60 byte packets 1 172.27.0.3 (172.27.0.3) 158.550 ms 158.371 ms 166.330 ms 2 192.168.3.253 (192.168.3.253) 166.135 ms 165.975 ms 166.307 ms root@pivpn:~# traceroute -4 -T -i wg0 192.168.3.253 traceroute to 192.168.3.253 (192.168.3.253), 30 hops max, 60 byte packets 1 172.27.0.3 (172.27.0.3) 59.417 ms 66.819 ms 72.106 ms 2 192.168.3.253 (192.168.3.253) 71.728 ms 71.502 ms 71.789 ms root@pivpn:~# traceroute -4 -T -i tun0 192.168.3.253 traceroute to 192.168.3.253 (192.168.3.253), 30 hops max, 60 byte packets 1 10.15.5.2 (10.15.5.2) 59.213 ms 66.880 ms 66.885 ms 2 192.168.3.253 (192.168.3.253) 66.944 ms 68.757 ms 68.930 ms Czy dzia\u0142a niezawodnie dowiem si\u0119 jak wy\u0142\u0105cz\u0119 ovpn \ud83d\ude00","title":"Test po\u0142\u0105czenia"},{"location":"2022-11-12-wireguard/#linki","text":"https://www.wireguard.com/quickstart/ https://www.howtogeek.com/657780/how-to-use-the-traceroute-command-on-linux/ https://www.howtogeek.com/howto/windows/adding-a-tcpip-route-to-the-windows-routing-table/ https://git.zx2c4.com/wireguard-tools/about/src/man/wg.8 https://git.zx2c4.com/wireguard-tools/about/src/man/wg-quick.8","title":"Linki"},{"location":"2022-12-25-ssh-certificates/","text":"2022.12.25 - SSH Certificates Intro Ostatnio pracuj\u0119 nad zestawieniem HomeLab/2 , a przerwa \u015bwi\u0105teczna pozwala pobawi\u0107 si\u0119 nowymi tematami. Mo\u017ce nie a\u017c tak nowymi bo z 2020 roku, ale nadal ma\u0142o popularnymi. Przygotowanie CA Pierwszym krokiem jest przygotowanie CA do podpisywania kluczy publicznych host\u00f3w i user\u00f3w. Mo\u017ce by\u0107 jeden wsp\u00f3lny, mo\u017ce by\u0107 kilka dedytkowanych. Nowe CA mo\u017cna wygenerowa\u0107 przy pomocy ssh-keygen # generate new CA $ ssh-keygen -t rsa -b 4096 -f trusted_user_ca -C 'SSH Validation CA' Na razie u\u017cywam pfSense do zarz\u0105dzania certami, wi\u0119c nowe subCA tam wygenerowa\u0142em. Po \u015bci\u0105gni\u0119ciu certa i klucza prywatnego nale\u017ca\u0142o je przekonwertowa\u0107 na format zrozumia\u0142y dla ssh-keygen . # convert openssl to openssh $ openssl x509 -inform pem -in nerdoza-studio-ssh-ca.crt -noout -pubkey > nerdoza-studio-ssh-ca.pubkey $ ssh-keygen -i -f nerdoza-studio-ssh-ca.pubkey -m PKCS8 > nerdoza-studio-ssh-ca.pub Konfiguracja serwera Podpisanie kluczy publicznych serwera \u017beby podpisa\u0107 klucze publiczne musimy mie\u0107 pod r\u0119k\u0105 klucz prywatny CA. Oczywi\u015bcie poszed\u0142em po linii najmniejszego oporu i po prostu wrzuci\u0142em CA.pub i CA.key bezpo\u015brenio na serwer docelowy do /etc/ssh \ud83d\ude42 Klucz publiczny musi by\u0107 w formacie OpenSSL (zaczyna\u0107 si\u0119 np. od ssh-rsa ) # sign public keys $ ssh-keygen -s nerdoza-studio-ssh-ca.key -I serwer.nerdoza.studio -h -n serwer.nerdoza.studio -V -5m:+3650d ssh_host_rsa_key.pub https://www.man7.org/linux/man-pages/man1/ssh-keygen.1.html -s - podpisanie klucza prywatnego wybranym kluczem CA ( CA.key ) -I - ustawienie to\u017csamo\u015bci podpisywanego klucza -h - utworzenie certyfikatu hosta zamiast certyfikatu usera -n - lista principals\u00f3w (nazwa hosta) -V - okres wa\u017cno\u015bci certyfikatu (5min wstecz, 10lat do przodu) Operacje wykona\u0142em dla ka\u017cdego typu klucza: rsa , ecdsa i ed25519 . W odpowiedzi dosta\u0142em potwierdzenie utworzenia certyfikatu. Signed host key serwer-cert.pub: id \"serwer.nerdoza.studio\" serial 0 for serwer.nerdoza.studio valid from 2022-12-26T19:32:27 to 2032-12-23T19:37:27 # view certificate $ ssh-keygen -Lf serwer-cert.pub serwer-cert.pub Konfiguracja sshd \u017beby skorzysta\u0107 z cert\u00f3w po stronie serwera nale\u017cy doda\u0107 nast\u0119puj\u0105ce opcje do sshd_config . HostKey /etc/ssh/ssh_host_rsa_key HostKey /etc/ssh/ssh_host_ecdsa_key HostKey /etc/ssh/ssh_host_ed25519_key HostCertificate /etc/ssh/ssh_host_rsa_key-cert.pub HostCertificate /etc/ssh/ssh_host_ecdsa_key-cert.pub HostCertificate /etc/ssh/ssh_host_ed25519_key-cert.pub PubkeyAuthentication yes # Accept user certs signed by this CA TrustedUserCAKeys /etc/ssh/nerdoza-studio-ssh-ca.pub # RevokedKeys /etc/ssh/revoked_keys Na koniec trzeba zrestartowa\u0107 sshd $ systemctl restart sshd Lista odwo\u0142anych kluczy czyli KRL SSH przyjmuje dwa rodzaje pliku z odwo\u0142anymi kluczami - plik tekstowy albo plik binarny: RevokedKeys Specifies revoked public keys file, or none to not use one. Keys listed in this file will be refused for public key authentication. Note that if this file is not readable, then public key authentication will be refused for all users. Keys may be specified as a text file, listing one public key per line, or as an OpenSSH Key Revocation List (KRL) as generated by ssh-keygen(1). For more information on KRLs, see the KEY REVOCATION LISTS section in ssh-keygen(1). Dla pliku tekstowego wystarczy wpisa\u0107 po jednym kluczu per linia ssh-rsa AAAAB... ssh-rsa AAAAB... W przypadku pliku binarnego trzeba nim zarz\u0105dza\u0107 przez ssh-keygen. https://www.man7.org/linux/man-pages/man1/ssh-keygen.1.html#KEY_REVOCATION_LISTS Opcji jest kilka - odwo\u0142anie przez serial number, public key albo hash to te kt\u00f3re mnie interesowa\u0142y. Hash mo\u017cna wyci\u0105gn\u0105\u0107 z /var/log/auth.log $ cat revoke.txt --- hash: SHA256:XXXXXXXXXXXXXXXXXX # create new KRL $ ssh-keygen -k -f /etc/ssh/revoked_keys revoke.txt # update KRL $ ssh-keygen -k -u -f /etc/ssh/revoked_keys revoke.txt Na razie nie u\u017cywam KRL, ale konfiguracj\u0119 mam przygotowan\u0105. # !!! IMPORTANT - file must be readable or SSH will deny all users !!! $ touch /etc/ssh/revoked_keys # uncomment in sshd_config RevokedKeys /etc/ssh/revoked_keys Na koniec mo\u017cna prze\u0142\u0105czy\u0107 niekt\u00f3re opcje sshd . PasswordAuthentication no # restrict pubkeys to certs only - PubkeyAcceptedKeyTypes or PubkeyAcceptedAlgorithms depending on sshd version PubkeyAcceptedKeyTypes ssh-ed25519-cert-v01@openssh.com,ecdsa-sha2-nistp256-cert-v01@openssh.com,ecdsa-sha2-nistp384-cert-v01@openssh.com,ecdsa-sha2-nistp521-cert-v01@openssh.com,sk-ssh-ed25519-cert-v01@openssh.com,sk-ecdsa-sha2-nistp256-cert-v01@openssh.com,rsa-sha2-512-cert-v01@openssh.com,rsa-sha2-256-cert-v01@openssh.com Akceptacja certyfikatu hosta przez klienta Konfiguracja ssh Dodajemy CA.pub do known_hosts @cert-authority *.nerdoza.studio ssh-rsa AAAAB... Konfiguracja Putty Tutaj jest wi\u0119cej zabawy i dodatkowo potrzeba Putty w wersji 0.78+ Wybieramy Configure host CAs Ustawiamy nazw\u0119, \u0142adujemy zawarto\u015b\u0107 z pliku, dodajemy list\u0119 host\u00f3w (analogicznie do known_hosts ) W rejestrze pojawi\u0105 si\u0119 nowe wpisy Konfiguracja klienta Podpisanie klucza Klucz podpisujemy analogicznie do podpisu serwera jednak bez opcji -h . # sign public key $ ssh-keygen -s ssh-ca.key -I myuser@myhost -n myuser -V -5m:+3650d myid_rsa.pub -n - lista principals\u00f3w (domy\u015blnie nazwy u\u017cytkownik\u00f3w, kt\u00f3rymi loguje si\u0119 klient, je\u015bli serwer nie ma ustawionej opcji AuthorizedPrincipalsFile) https://man.openbsd.org/sshd_config.5#AuthorizedPrincipalsFile Konfiguracja ssh Dodajemy wpisy do pliku ~/.ssh/config . Dodatkowo ustawi\u0142em list\u0119 u\u017cywanych algorytm\u00f3w algorytm\u00f3w (tylko certy). https://man.openbsd.org/ssh_config#PubkeyAcceptedAlgorithms Host myhost IdentitiesOnly yes IdentityFile ~/.ssh/myid_rsa PubkeyAcceptedAlgorithms ssh-ed25519-cert-v01@openssh.com,ecdsa-sha2-nistp256-cert-v01@openssh.com,ecdsa-sha2-nistp384-cert-v01@openssh.com,ecdsa-sha2-nistp521-cert-v01@openssh.com,sk-ssh-ed25519-cert-v01@openssh.com,sk-ecdsa-sha2-nistp256-cert-v01@openssh.com,rsa-sha2-512-cert-v01@openssh.com,rsa-sha2-256-cert-v01@openssh.com User myuser Weryfikujemy po\u0142\u0105czenie przez dodanie -v do komendy ssh . (...) debug1: Reading configuration data C:\\\\Users\\\\#####/.ssh/config debug1: C:\\\\Users\\\\#####/.ssh/config line 4: Applying options for serwer.nerdoza.studio debug1: C:\\\\Users\\\\#####/.ssh/config line 7: Applying options for * debug1: Connecting to serwer.nerdoza.studio [192.*.*.*] port 22. debug1: Connection established. debug1: identity file C:\\\\Users\\\\#####/.ssh/mykey_rsa type 0 debug1: identity file C:\\\\Users\\\\#####/.ssh/mykey_rsa-cert type 4 debug1: Authenticating to serwer.nerdoza.studio:22 as '#####' debug1: Server host certificate: ssh-ed25519-cert-v01@openssh.com SHA256:#####, serial 0 ID \"serwer.nerdoza.studio\" CA ssh-rsa SHA256:##### valid from 2022-12-26T02:22:00 to 2032-12-23T02:23:17 debug1: Host 'serwer.nerdoza.studio' is known and matches the ED25519-CERT host certificate. debug1: Found CA key in C:\\\\Users\\\\#####/.ssh/known_hosts:1 debug1: Skipping ssh-rsa key C:\\\\Users\\\\#####/.ssh/mykey_rsa - corresponding algo not in PubkeyAcceptedAlgorithms debug1: Will attempt key: C:\\\\Users\\\\#####/.ssh/mykey_rsa RSA-CERT SHA256:##### explicit debug1: Authentications that can continue: publickey debug1: Next authentication method: publickey debug1: Offering public key: C:\\\\Users\\\\#####/.ssh/mykey_rsa RSA-CERT SHA256:##### explicit debug1: Server accepts key: C:\\\\Users\\\\#####/.ssh/mykey_rsa RSA-CERT SHA256:##### explicit debug1: Authentication succeeded (publickey). Authenticated to serwer.nerdoza.studio ([192.*.*.*]:22). (...) Konfiguracja Putty Najpierw nale\u017cy przekonwertowa\u0107 klucz prywatny do postaci PPK. https://gcore.com/support/articles/360012640597/ Nast\u0119pnie konfiguracj\u0119 w Putty ustawiam per sesj\u0119. Podczas po\u0142\u0105czenia wyskakuje monit o has\u0142o do klucza prywatnego (PPK). U\u017cycie cert\u00f3w mo\u017cemy zweryfikowa\u0107 w logu Puttiego (w\u0142\u0105czamy przez Session \u2192 Logging) (...) Incoming packet #0x2, type 21 / 0x15 (SSH2_MSG_NEWKEYS) Event Log: Server also has ssh-ed25519/ecdsa-sha2-nistp256/rsa-sha2-512/rsa-sha2-256/ssh-rsa/ecdsa-sha2-nistp256-cert-v01@openssh.com/rsa-sha2-512-cert-v01@openssh.com/rsa-sha2-256-cert-v01@openssh.com/ssh-rsa-cert-v01@openssh.com host keys, but we don't know any of them Event Log: Host key fingerprint is: Event Log: ssh-ed25519-cert-v01@openssh.com 255 SHA256:##### Event Log: Host key is a certificate. Hash including certificate: Event Log: ssh-ed25519-cert-v01@openssh.com 255 SHA256:##### Event Log: Certificate ID string is \"serwer.nerdoza.studio\" Event Log: Fingerprint of certification authority: Event Log: ssh-rsa 4096 SHA256:##### Event Log: Certification authority matches 'nerdoza-studio-ssh-ca' Event Log: Accepted certificate Outgoing packet #0x2, type 21 / 0x15 (SSH2_MSG_NEWKEYS) (...) Incoming packet #0x4, type 6 / 0x06 (SSH2_MSG_SERVICE_ACCEPT) Event Log: Reading key file \"C:\\Users\\#####\\.ssh\\mykey_rsa.ppk\" Event Log: Reading certificate file \"C:\\Users\\#####\\.ssh\\mykey_rsa-cert.pub\" Outgoing packet #0x4, type 50 / 0x32 (SSH2_MSG_USERAUTH_REQUEST) Incoming packet #0x5, type 51 / 0x33 (SSH2_MSG_USERAUTH_FAILURE) Event Log: Sending public key with certificate from \"C:\\Users\\#####\\.ssh\\mykey_rsa-cert.pub\" Event Log: Offered public key Outgoing packet #0x5, type 50 / 0x32 (SSH2_MSG_USERAUTH_REQUEST) Incoming packet #0x6, type 60 / 0x3c (SSH2_MSG_USERAUTH_PK_OK) Event Log: Offer of public key accepted Event Log: Sent public key signature Outgoing packet #0x6, type 50 / 0x32 (SSH2_MSG_USERAUTH_REQUEST) Incoming packet #0x7, type 52 / 0x34 (SSH2_MSG_USERAUTH_SUCCESS) Event Log: Access granted Event Log: Opening main session channel (...) Linki https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Certificate-based_Authentication https://goteleport.com/blog/how-to-configure-ssh-certificate-based-authentication/ https://www.lorier.net/docs/ssh-ca.html https://www.man7.org/linux/man-pages/man1/ssh-keygen.1.html#KEY_REVOCATION_LISTS https://the.earth.li/~sgtatham/putty/0.78/htmldoc/Chapter4.html#config-ssh-auth-creds https://sleeplessbeastie.eu/2020/02/17/how-to-revoke-specific-key-used-to-login-with-openssh/ https://www.youtube.com/watch?v=lYzklWPTbsQ","title":"2022.12.25 - SSH Certificates"},{"location":"2022-12-25-ssh-certificates/#20221225-ssh-certificates","text":"","title":"2022.12.25 - SSH Certificates"},{"location":"2022-12-25-ssh-certificates/#intro","text":"Ostatnio pracuj\u0119 nad zestawieniem HomeLab/2 , a przerwa \u015bwi\u0105teczna pozwala pobawi\u0107 si\u0119 nowymi tematami. Mo\u017ce nie a\u017c tak nowymi bo z 2020 roku, ale nadal ma\u0142o popularnymi.","title":"Intro"},{"location":"2022-12-25-ssh-certificates/#przygotowanie-ca","text":"Pierwszym krokiem jest przygotowanie CA do podpisywania kluczy publicznych host\u00f3w i user\u00f3w. Mo\u017ce by\u0107 jeden wsp\u00f3lny, mo\u017ce by\u0107 kilka dedytkowanych. Nowe CA mo\u017cna wygenerowa\u0107 przy pomocy ssh-keygen # generate new CA $ ssh-keygen -t rsa -b 4096 -f trusted_user_ca -C 'SSH Validation CA' Na razie u\u017cywam pfSense do zarz\u0105dzania certami, wi\u0119c nowe subCA tam wygenerowa\u0142em. Po \u015bci\u0105gni\u0119ciu certa i klucza prywatnego nale\u017ca\u0142o je przekonwertowa\u0107 na format zrozumia\u0142y dla ssh-keygen . # convert openssl to openssh $ openssl x509 -inform pem -in nerdoza-studio-ssh-ca.crt -noout -pubkey > nerdoza-studio-ssh-ca.pubkey $ ssh-keygen -i -f nerdoza-studio-ssh-ca.pubkey -m PKCS8 > nerdoza-studio-ssh-ca.pub","title":"Przygotowanie CA"},{"location":"2022-12-25-ssh-certificates/#konfiguracja-serwera","text":"","title":"Konfiguracja serwera"},{"location":"2022-12-25-ssh-certificates/#podpisanie-kluczy-publicznych-serwera","text":"\u017beby podpisa\u0107 klucze publiczne musimy mie\u0107 pod r\u0119k\u0105 klucz prywatny CA. Oczywi\u015bcie poszed\u0142em po linii najmniejszego oporu i po prostu wrzuci\u0142em CA.pub i CA.key bezpo\u015brenio na serwer docelowy do /etc/ssh \ud83d\ude42 Klucz publiczny musi by\u0107 w formacie OpenSSL (zaczyna\u0107 si\u0119 np. od ssh-rsa ) # sign public keys $ ssh-keygen -s nerdoza-studio-ssh-ca.key -I serwer.nerdoza.studio -h -n serwer.nerdoza.studio -V -5m:+3650d ssh_host_rsa_key.pub https://www.man7.org/linux/man-pages/man1/ssh-keygen.1.html -s - podpisanie klucza prywatnego wybranym kluczem CA ( CA.key ) -I - ustawienie to\u017csamo\u015bci podpisywanego klucza -h - utworzenie certyfikatu hosta zamiast certyfikatu usera -n - lista principals\u00f3w (nazwa hosta) -V - okres wa\u017cno\u015bci certyfikatu (5min wstecz, 10lat do przodu) Operacje wykona\u0142em dla ka\u017cdego typu klucza: rsa , ecdsa i ed25519 . W odpowiedzi dosta\u0142em potwierdzenie utworzenia certyfikatu. Signed host key serwer-cert.pub: id \"serwer.nerdoza.studio\" serial 0 for serwer.nerdoza.studio valid from 2022-12-26T19:32:27 to 2032-12-23T19:37:27 # view certificate $ ssh-keygen -Lf serwer-cert.pub serwer-cert.pub","title":"Podpisanie kluczy publicznych serwera"},{"location":"2022-12-25-ssh-certificates/#konfiguracja-sshd","text":"\u017beby skorzysta\u0107 z cert\u00f3w po stronie serwera nale\u017cy doda\u0107 nast\u0119puj\u0105ce opcje do sshd_config . HostKey /etc/ssh/ssh_host_rsa_key HostKey /etc/ssh/ssh_host_ecdsa_key HostKey /etc/ssh/ssh_host_ed25519_key HostCertificate /etc/ssh/ssh_host_rsa_key-cert.pub HostCertificate /etc/ssh/ssh_host_ecdsa_key-cert.pub HostCertificate /etc/ssh/ssh_host_ed25519_key-cert.pub PubkeyAuthentication yes # Accept user certs signed by this CA TrustedUserCAKeys /etc/ssh/nerdoza-studio-ssh-ca.pub # RevokedKeys /etc/ssh/revoked_keys Na koniec trzeba zrestartowa\u0107 sshd $ systemctl restart sshd","title":"Konfiguracja sshd"},{"location":"2022-12-25-ssh-certificates/#lista-odwoanych-kluczy-czyli-krl","text":"SSH przyjmuje dwa rodzaje pliku z odwo\u0142anymi kluczami - plik tekstowy albo plik binarny: RevokedKeys Specifies revoked public keys file, or none to not use one. Keys listed in this file will be refused for public key authentication. Note that if this file is not readable, then public key authentication will be refused for all users. Keys may be specified as a text file, listing one public key per line, or as an OpenSSH Key Revocation List (KRL) as generated by ssh-keygen(1). For more information on KRLs, see the KEY REVOCATION LISTS section in ssh-keygen(1). Dla pliku tekstowego wystarczy wpisa\u0107 po jednym kluczu per linia ssh-rsa AAAAB... ssh-rsa AAAAB... W przypadku pliku binarnego trzeba nim zarz\u0105dza\u0107 przez ssh-keygen. https://www.man7.org/linux/man-pages/man1/ssh-keygen.1.html#KEY_REVOCATION_LISTS Opcji jest kilka - odwo\u0142anie przez serial number, public key albo hash to te kt\u00f3re mnie interesowa\u0142y. Hash mo\u017cna wyci\u0105gn\u0105\u0107 z /var/log/auth.log $ cat revoke.txt --- hash: SHA256:XXXXXXXXXXXXXXXXXX # create new KRL $ ssh-keygen -k -f /etc/ssh/revoked_keys revoke.txt # update KRL $ ssh-keygen -k -u -f /etc/ssh/revoked_keys revoke.txt Na razie nie u\u017cywam KRL, ale konfiguracj\u0119 mam przygotowan\u0105. # !!! IMPORTANT - file must be readable or SSH will deny all users !!! $ touch /etc/ssh/revoked_keys # uncomment in sshd_config RevokedKeys /etc/ssh/revoked_keys Na koniec mo\u017cna prze\u0142\u0105czy\u0107 niekt\u00f3re opcje sshd . PasswordAuthentication no # restrict pubkeys to certs only - PubkeyAcceptedKeyTypes or PubkeyAcceptedAlgorithms depending on sshd version PubkeyAcceptedKeyTypes ssh-ed25519-cert-v01@openssh.com,ecdsa-sha2-nistp256-cert-v01@openssh.com,ecdsa-sha2-nistp384-cert-v01@openssh.com,ecdsa-sha2-nistp521-cert-v01@openssh.com,sk-ssh-ed25519-cert-v01@openssh.com,sk-ecdsa-sha2-nistp256-cert-v01@openssh.com,rsa-sha2-512-cert-v01@openssh.com,rsa-sha2-256-cert-v01@openssh.com","title":"Lista odwo\u0142anych kluczy czyli KRL"},{"location":"2022-12-25-ssh-certificates/#akceptacja-certyfikatu-hosta-przez-klienta","text":"","title":"Akceptacja certyfikatu hosta przez klienta"},{"location":"2022-12-25-ssh-certificates/#konfiguracja-ssh","text":"Dodajemy CA.pub do known_hosts @cert-authority *.nerdoza.studio ssh-rsa AAAAB...","title":"Konfiguracja ssh"},{"location":"2022-12-25-ssh-certificates/#konfiguracja-putty","text":"Tutaj jest wi\u0119cej zabawy i dodatkowo potrzeba Putty w wersji 0.78+ Wybieramy Configure host CAs Ustawiamy nazw\u0119, \u0142adujemy zawarto\u015b\u0107 z pliku, dodajemy list\u0119 host\u00f3w (analogicznie do known_hosts ) W rejestrze pojawi\u0105 si\u0119 nowe wpisy","title":"Konfiguracja Putty"},{"location":"2022-12-25-ssh-certificates/#konfiguracja-klienta","text":"","title":"Konfiguracja klienta"},{"location":"2022-12-25-ssh-certificates/#podpisanie-klucza","text":"Klucz podpisujemy analogicznie do podpisu serwera jednak bez opcji -h . # sign public key $ ssh-keygen -s ssh-ca.key -I myuser@myhost -n myuser -V -5m:+3650d myid_rsa.pub -n - lista principals\u00f3w (domy\u015blnie nazwy u\u017cytkownik\u00f3w, kt\u00f3rymi loguje si\u0119 klient, je\u015bli serwer nie ma ustawionej opcji AuthorizedPrincipalsFile) https://man.openbsd.org/sshd_config.5#AuthorizedPrincipalsFile","title":"Podpisanie klucza"},{"location":"2022-12-25-ssh-certificates/#konfiguracja-ssh_1","text":"Dodajemy wpisy do pliku ~/.ssh/config . Dodatkowo ustawi\u0142em list\u0119 u\u017cywanych algorytm\u00f3w algorytm\u00f3w (tylko certy). https://man.openbsd.org/ssh_config#PubkeyAcceptedAlgorithms Host myhost IdentitiesOnly yes IdentityFile ~/.ssh/myid_rsa PubkeyAcceptedAlgorithms ssh-ed25519-cert-v01@openssh.com,ecdsa-sha2-nistp256-cert-v01@openssh.com,ecdsa-sha2-nistp384-cert-v01@openssh.com,ecdsa-sha2-nistp521-cert-v01@openssh.com,sk-ssh-ed25519-cert-v01@openssh.com,sk-ecdsa-sha2-nistp256-cert-v01@openssh.com,rsa-sha2-512-cert-v01@openssh.com,rsa-sha2-256-cert-v01@openssh.com User myuser Weryfikujemy po\u0142\u0105czenie przez dodanie -v do komendy ssh . (...) debug1: Reading configuration data C:\\\\Users\\\\#####/.ssh/config debug1: C:\\\\Users\\\\#####/.ssh/config line 4: Applying options for serwer.nerdoza.studio debug1: C:\\\\Users\\\\#####/.ssh/config line 7: Applying options for * debug1: Connecting to serwer.nerdoza.studio [192.*.*.*] port 22. debug1: Connection established. debug1: identity file C:\\\\Users\\\\#####/.ssh/mykey_rsa type 0 debug1: identity file C:\\\\Users\\\\#####/.ssh/mykey_rsa-cert type 4 debug1: Authenticating to serwer.nerdoza.studio:22 as '#####' debug1: Server host certificate: ssh-ed25519-cert-v01@openssh.com SHA256:#####, serial 0 ID \"serwer.nerdoza.studio\" CA ssh-rsa SHA256:##### valid from 2022-12-26T02:22:00 to 2032-12-23T02:23:17 debug1: Host 'serwer.nerdoza.studio' is known and matches the ED25519-CERT host certificate. debug1: Found CA key in C:\\\\Users\\\\#####/.ssh/known_hosts:1 debug1: Skipping ssh-rsa key C:\\\\Users\\\\#####/.ssh/mykey_rsa - corresponding algo not in PubkeyAcceptedAlgorithms debug1: Will attempt key: C:\\\\Users\\\\#####/.ssh/mykey_rsa RSA-CERT SHA256:##### explicit debug1: Authentications that can continue: publickey debug1: Next authentication method: publickey debug1: Offering public key: C:\\\\Users\\\\#####/.ssh/mykey_rsa RSA-CERT SHA256:##### explicit debug1: Server accepts key: C:\\\\Users\\\\#####/.ssh/mykey_rsa RSA-CERT SHA256:##### explicit debug1: Authentication succeeded (publickey). Authenticated to serwer.nerdoza.studio ([192.*.*.*]:22). (...)","title":"Konfiguracja ssh"},{"location":"2022-12-25-ssh-certificates/#konfiguracja-putty_1","text":"Najpierw nale\u017cy przekonwertowa\u0107 klucz prywatny do postaci PPK. https://gcore.com/support/articles/360012640597/ Nast\u0119pnie konfiguracj\u0119 w Putty ustawiam per sesj\u0119. Podczas po\u0142\u0105czenia wyskakuje monit o has\u0142o do klucza prywatnego (PPK). U\u017cycie cert\u00f3w mo\u017cemy zweryfikowa\u0107 w logu Puttiego (w\u0142\u0105czamy przez Session \u2192 Logging) (...) Incoming packet #0x2, type 21 / 0x15 (SSH2_MSG_NEWKEYS) Event Log: Server also has ssh-ed25519/ecdsa-sha2-nistp256/rsa-sha2-512/rsa-sha2-256/ssh-rsa/ecdsa-sha2-nistp256-cert-v01@openssh.com/rsa-sha2-512-cert-v01@openssh.com/rsa-sha2-256-cert-v01@openssh.com/ssh-rsa-cert-v01@openssh.com host keys, but we don't know any of them Event Log: Host key fingerprint is: Event Log: ssh-ed25519-cert-v01@openssh.com 255 SHA256:##### Event Log: Host key is a certificate. Hash including certificate: Event Log: ssh-ed25519-cert-v01@openssh.com 255 SHA256:##### Event Log: Certificate ID string is \"serwer.nerdoza.studio\" Event Log: Fingerprint of certification authority: Event Log: ssh-rsa 4096 SHA256:##### Event Log: Certification authority matches 'nerdoza-studio-ssh-ca' Event Log: Accepted certificate Outgoing packet #0x2, type 21 / 0x15 (SSH2_MSG_NEWKEYS) (...) Incoming packet #0x4, type 6 / 0x06 (SSH2_MSG_SERVICE_ACCEPT) Event Log: Reading key file \"C:\\Users\\#####\\.ssh\\mykey_rsa.ppk\" Event Log: Reading certificate file \"C:\\Users\\#####\\.ssh\\mykey_rsa-cert.pub\" Outgoing packet #0x4, type 50 / 0x32 (SSH2_MSG_USERAUTH_REQUEST) Incoming packet #0x5, type 51 / 0x33 (SSH2_MSG_USERAUTH_FAILURE) Event Log: Sending public key with certificate from \"C:\\Users\\#####\\.ssh\\mykey_rsa-cert.pub\" Event Log: Offered public key Outgoing packet #0x5, type 50 / 0x32 (SSH2_MSG_USERAUTH_REQUEST) Incoming packet #0x6, type 60 / 0x3c (SSH2_MSG_USERAUTH_PK_OK) Event Log: Offer of public key accepted Event Log: Sent public key signature Outgoing packet #0x6, type 50 / 0x32 (SSH2_MSG_USERAUTH_REQUEST) Incoming packet #0x7, type 52 / 0x34 (SSH2_MSG_USERAUTH_SUCCESS) Event Log: Access granted Event Log: Opening main session channel (...)","title":"Konfiguracja Putty"},{"location":"2022-12-25-ssh-certificates/#linki","text":"https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Certificate-based_Authentication https://goteleport.com/blog/how-to-configure-ssh-certificate-based-authentication/ https://www.lorier.net/docs/ssh-ca.html https://www.man7.org/linux/man-pages/man1/ssh-keygen.1.html#KEY_REVOCATION_LISTS https://the.earth.li/~sgtatham/putty/0.78/htmldoc/Chapter4.html#config-ssh-auth-creds https://sleeplessbeastie.eu/2020/02/17/how-to-revoke-specific-key-used-to-login-with-openssh/ https://www.youtube.com/watch?v=lYzklWPTbsQ","title":"Linki"},{"location":"2024-04-27-factorio/","text":"2024.04.27 - Factorio Headless Server Intro Prace nad HomeLab/3 post\u0119puj\u0105 i kolejnym wa\u017cnym krokiem jest serwerek Factorio (pewnie nawet kilka) \ud83d\ude01 Przygotowanie VM Postanowi\u0142em zainstalowa\u0107 Factorio Headless Server (alias FHS ) na dedykowanej maszynce. W PVE wyklika\u0142em nast\u0119puj\u0105c\u0105 VMk\u0119: pve - vm Nast\u0119pnie przygotowa\u0142em maszyn\u0119 z domowego playbooka Ansibla : konfiguracja sshd (klucze) instalacja pakiet\u00f3w Instalacja serwera Serwer b\u0119dzie chodzi\u0142 bezpo\u015brednio na maszynie (na razie bez dockera). Przygotowanie katalog\u00f3w, u\u017cytkownika i plik\u00f3w (wszystkie peracje z poziomu root ): # add user $ adduser --disabled-login --no-create-home --gecos factorio factorio # download server $ cd /opt $ wget -O factorio-headless-1.1.107.tar.xz https://www.factorio.com/get-download/1.1.107/headless/linux64 $ tar -xJf factorio-headless-1.1.107.tar.xz # prepare folders $ cd factorio $ mkdir saves mods # create config $ cp -a server-settings.example.json server-settings.json # set permissions $ chown -R factorio:factorio /opt/factorio Nast\u0119pnie poprawi\u0142em konfiguracj\u0119 serwera i ustawi\u0142em gr\u0119 prywatn\u0105 z hase\u0142kiem. $ mcedit /opt/factorio/data/server-settings.json --- { \"name\": \"HomeLab/3/Factorio\", \"description\": \"Vanilla\", \"tags\": [\"homelab\", \"nerdoza\"], \"visibility\": { \"public\": false, \"lan\": true }, \"game_password\": \"<tajne-przez-poufne>\", \"<inne ustawienia>\": \"(...)\" } Dodatkowo utworzy\u0142em list\u0119 admin\u00f3w serwera. $ mcedit /opt/factorio/server-adminlist.json --- [ \"kim-jestes?-jestem-adminem!\" ] Przygotowanie serwis\u00f3w Serwer b\u0119dzie odpalany przez systemd. W przypadku awarii ma zosta\u0107 wys\u0142ane powiadomienie na prywatn\u0105 instancj\u0119 ntfy . \"G\u0142\u00f3wny\" serwis FHS ( gist ) Podczas awarii zostanie wyzwolony serwis ntfy@.service z nazw\u0105 aktualnego unitu %n . ( docs ) ExecStopPost= powoduje 'fail' serwisu nawet w przypadku r\u0119cznego zatrzymania i wys\u0142anie powiadomienia na ntfy . P\u00f3\u017aniej\u2122 rozszerz\u0119 powiadomenia o zdarzeniach uruchomienia/zatrzymania serwera. $ mcedit /etc/systemd/system/factorio.service --- [Unit] Description=Factorio Headless Server After=network.target OnFailure=ntfy@%n.service [Service] Type=simple User=factorio WorkingDirectory=/opt/factorio ExecStart=/opt/factorio/bin/x64/factorio --start-server-load-latest --server-settings ./data/server-settings.json ExecStopPost=/bin/false Restart=on-failure RestartSec=60s [Install] WantedBy=multi-user.target Serwis do powiadomie\u0144 ntfy ( gist ) Przekazujemy orginaln\u0105 nazw\u0119 unitu w nazwie instancji %i ( docs ) $ mcedit /etc/systemd/system/ntfy@.service --- [Unit] Description=Notify about service failure [Service] Type=oneshot ExecStart=/usr/local/sbin/ntfy.sh %i [Install] WantedBy=multi-user.target Skrypt notyfikuj\u0105cy ntfy ( gist ) $ mcedit /usr/local/sbin/ntfy.sh --- #!/bin/bash # Get input SERVICE_NAME=${1:-service_unknown} # Local variables NTFY_URL=\"https://ntfy.home/\" NTFY_AUTH=\"Basic <auth>\" NTFY_TOPIC=homelab # Get status STATUS=$(systemctl is-active $SERVICE_NAME) # Compute message MESSAGE=$(jq -cn '{\"topic\": $topic, \"message\": $message}' \\ --arg topic \"$NTFY_TOPIC\" \\ --arg message \"Service $SERVICE_NAME is ${STATUS:-status_unknown}\") # Send notification curl -qk --connect-timeout 5 \\ -X POST $NTFY_URL \\ -H \"Authorization: $NTFY_AUTH\" \\ -H \"X-Tags: rotating_light\" \\ -H \"X-Title: $SERVICE_NAME\" \\ -H \"X-Priority: 4\" \\ -H \"Content-Type: application/json\" \\ -d \"$MESSAGE\" Uruchomienie serwera Za pierwszym razem trzeba wygenerowa\u0107 map\u0119 do gry. Nie bawi\u0142em si\u0119 w \u017cadne customizacje generatora wi\u0119c komenda wygl\u0105da prosto $ cd /opt/factorio/saves $ sudo -u factorio /opt/factorio/bin/x64/factorio --create map01.zip Odpalenie serwera sprowadza si\u0119 kilku komend systemctl # enable service $ systemctl enable factorio.service # start service $ systemctl start factorio.service # check status $ systemctl status factorio.service \u25cf factorio.service - Factorio Headless Server Loaded: loaded (/etc/systemd/system/factorio.service; enabled; preset: enabled) Active: active (running) since Sat 2024-04-27 20:14:04 CEST; 46min ago Main PID: 11889 (factorio) Tasks: 13 (limit: 2303) Memory: 206.8M CPU: 15.110s CGroup: /system.slice/factorio.service \u2514\u250011889 /opt/factorio/bin/x64/factorio --start-server-load-latest --server-settings ./data/server-settings.json Restart serwera powoduje wys\u0142anie powiadomienia na telefon. Linki https://wiki.factorio.com/Multiplayer#Dedicated/Headless_server https://www.freedesktop.org/software/systemd/man/latest/systemd.unit.html https://www.freedesktop.org/software/systemd/man/latest/systemd.service.html https://ntfy.sh/","title":"2024.04.27 - Factorio Headless Server"},{"location":"2024-04-27-factorio/#20240427-factorio-headless-server","text":"","title":"2024.04.27 - Factorio Headless Server"},{"location":"2024-04-27-factorio/#intro","text":"Prace nad HomeLab/3 post\u0119puj\u0105 i kolejnym wa\u017cnym krokiem jest serwerek Factorio (pewnie nawet kilka) \ud83d\ude01","title":"Intro"},{"location":"2024-04-27-factorio/#przygotowanie-vm","text":"Postanowi\u0142em zainstalowa\u0107 Factorio Headless Server (alias FHS ) na dedykowanej maszynce. W PVE wyklika\u0142em nast\u0119puj\u0105c\u0105 VMk\u0119: pve - vm Nast\u0119pnie przygotowa\u0142em maszyn\u0119 z domowego playbooka Ansibla : konfiguracja sshd (klucze) instalacja pakiet\u00f3w","title":"Przygotowanie VM"},{"location":"2024-04-27-factorio/#instalacja-serwera","text":"Serwer b\u0119dzie chodzi\u0142 bezpo\u015brednio na maszynie (na razie bez dockera). Przygotowanie katalog\u00f3w, u\u017cytkownika i plik\u00f3w (wszystkie peracje z poziomu root ): # add user $ adduser --disabled-login --no-create-home --gecos factorio factorio # download server $ cd /opt $ wget -O factorio-headless-1.1.107.tar.xz https://www.factorio.com/get-download/1.1.107/headless/linux64 $ tar -xJf factorio-headless-1.1.107.tar.xz # prepare folders $ cd factorio $ mkdir saves mods # create config $ cp -a server-settings.example.json server-settings.json # set permissions $ chown -R factorio:factorio /opt/factorio Nast\u0119pnie poprawi\u0142em konfiguracj\u0119 serwera i ustawi\u0142em gr\u0119 prywatn\u0105 z hase\u0142kiem. $ mcedit /opt/factorio/data/server-settings.json --- { \"name\": \"HomeLab/3/Factorio\", \"description\": \"Vanilla\", \"tags\": [\"homelab\", \"nerdoza\"], \"visibility\": { \"public\": false, \"lan\": true }, \"game_password\": \"<tajne-przez-poufne>\", \"<inne ustawienia>\": \"(...)\" } Dodatkowo utworzy\u0142em list\u0119 admin\u00f3w serwera. $ mcedit /opt/factorio/server-adminlist.json --- [ \"kim-jestes?-jestem-adminem!\" ]","title":"Instalacja serwera"},{"location":"2024-04-27-factorio/#przygotowanie-serwisow","text":"Serwer b\u0119dzie odpalany przez systemd. W przypadku awarii ma zosta\u0107 wys\u0142ane powiadomienie na prywatn\u0105 instancj\u0119 ntfy . \"G\u0142\u00f3wny\" serwis FHS ( gist ) Podczas awarii zostanie wyzwolony serwis ntfy@.service z nazw\u0105 aktualnego unitu %n . ( docs ) ExecStopPost= powoduje 'fail' serwisu nawet w przypadku r\u0119cznego zatrzymania i wys\u0142anie powiadomienia na ntfy . P\u00f3\u017aniej\u2122 rozszerz\u0119 powiadomenia o zdarzeniach uruchomienia/zatrzymania serwera. $ mcedit /etc/systemd/system/factorio.service --- [Unit] Description=Factorio Headless Server After=network.target OnFailure=ntfy@%n.service [Service] Type=simple User=factorio WorkingDirectory=/opt/factorio ExecStart=/opt/factorio/bin/x64/factorio --start-server-load-latest --server-settings ./data/server-settings.json ExecStopPost=/bin/false Restart=on-failure RestartSec=60s [Install] WantedBy=multi-user.target Serwis do powiadomie\u0144 ntfy ( gist ) Przekazujemy orginaln\u0105 nazw\u0119 unitu w nazwie instancji %i ( docs ) $ mcedit /etc/systemd/system/ntfy@.service --- [Unit] Description=Notify about service failure [Service] Type=oneshot ExecStart=/usr/local/sbin/ntfy.sh %i [Install] WantedBy=multi-user.target Skrypt notyfikuj\u0105cy ntfy ( gist ) $ mcedit /usr/local/sbin/ntfy.sh --- #!/bin/bash # Get input SERVICE_NAME=${1:-service_unknown} # Local variables NTFY_URL=\"https://ntfy.home/\" NTFY_AUTH=\"Basic <auth>\" NTFY_TOPIC=homelab # Get status STATUS=$(systemctl is-active $SERVICE_NAME) # Compute message MESSAGE=$(jq -cn '{\"topic\": $topic, \"message\": $message}' \\ --arg topic \"$NTFY_TOPIC\" \\ --arg message \"Service $SERVICE_NAME is ${STATUS:-status_unknown}\") # Send notification curl -qk --connect-timeout 5 \\ -X POST $NTFY_URL \\ -H \"Authorization: $NTFY_AUTH\" \\ -H \"X-Tags: rotating_light\" \\ -H \"X-Title: $SERVICE_NAME\" \\ -H \"X-Priority: 4\" \\ -H \"Content-Type: application/json\" \\ -d \"$MESSAGE\"","title":"Przygotowanie serwis\u00f3w"},{"location":"2024-04-27-factorio/#uruchomienie-serwera","text":"Za pierwszym razem trzeba wygenerowa\u0107 map\u0119 do gry. Nie bawi\u0142em si\u0119 w \u017cadne customizacje generatora wi\u0119c komenda wygl\u0105da prosto $ cd /opt/factorio/saves $ sudo -u factorio /opt/factorio/bin/x64/factorio --create map01.zip Odpalenie serwera sprowadza si\u0119 kilku komend systemctl # enable service $ systemctl enable factorio.service # start service $ systemctl start factorio.service # check status $ systemctl status factorio.service \u25cf factorio.service - Factorio Headless Server Loaded: loaded (/etc/systemd/system/factorio.service; enabled; preset: enabled) Active: active (running) since Sat 2024-04-27 20:14:04 CEST; 46min ago Main PID: 11889 (factorio) Tasks: 13 (limit: 2303) Memory: 206.8M CPU: 15.110s CGroup: /system.slice/factorio.service \u2514\u250011889 /opt/factorio/bin/x64/factorio --start-server-load-latest --server-settings ./data/server-settings.json Restart serwera powoduje wys\u0142anie powiadomienia na telefon.","title":"Uruchomienie serwera"},{"location":"2024-04-27-factorio/#linki","text":"https://wiki.factorio.com/Multiplayer#Dedicated/Headless_server https://www.freedesktop.org/software/systemd/man/latest/systemd.unit.html https://www.freedesktop.org/software/systemd/man/latest/systemd.service.html https://ntfy.sh/","title":"Linki"},{"location":"2024-05-17-factorio-stats/","text":"2024.05.17 - Factorio Stats Intro Wpad\u0142 pomys\u0142, \u017ceby wyci\u0105gn\u0105\u0107 statystyki Factorio do zewn\u0119trznego wizualizatora. Wymagania s\u0105 do\u015b\u0107 proste: eksport danych do JSON'a, najlepiej aby NIE wymaga\u0142 MOD'a do gry (mo\u017cna b\u0119dzie si\u0119 \u0142\u0105czy\u0107 do serwera ze Switcha, kt\u00f3ry mod\u00f3w nie obs\u0142uguje), eksport danych do ElasticStacka (logstash jako transformator danych, elasticsearch jako baza danych), wizualizacja Kibana albo Grafana. Z zajawk\u0105 projektu pom\u00f3g\u0142 mi ChatGTP od dzisiaj zwany przeze mnie pieszczotliwie Junior . By\u0142o kilka pr\u00f3b odczytu statystyk, co rzutowa\u0142o na ko\u0144cowy kszta\u0142t skryptu. Pomys\u0142y, kt\u00f3re by\u0142y testowane: zapis do jednego pliku, logrotate i Filebeat/czytacz_w_pytongu emulacja pliku przez skrypt w pytongu z wykorzystaniem fusepy ( Filesystem in USErspace - ciekawe rozwi\u0105zanie - nadal rozwa\u017cam testy) zapis do nowych plik\u00f3w (per tick), odczyt przez Filebeat'a, skrypt sprz\u0105taj\u0105cy (bufor na pliki - docelowo wrzuca\u0107 na tmpfs) Skrypt statystyk dla Factorio Forma eksportu danych jest ograniczona przez mo\u017cliwo\u015bci LUA w Factorio. W sumie jedynym prostym sposobem jest utworzenie drzewka danych i eksport do pliku w formacie JSON. Aktualnie skrypt jest wstrzykni\u0119ty w istniej\u0105cego sejwa (mo\u017cna to przerobi\u0107 na Scenario ale nie bawi\u0142em si\u0119 tym jeszcze, wi\u0119c nie wiem jak to zrobi\u0107). Pr\u00f3bowa\u0142em z r\u00f3\u017cnymi formami skryptu i najbardziej mi odpowiada forma biblioteki. \u0141adowanie biblioteki nale\u017cy wprowadzi\u0107 do pliku control.lua . -- control.lua -- orginal savefile contents local handler = require(\"event_handler\") handler.add_lib(require(\"freeplay\")) handler.add_lib(require(\"silo-script\")) -- add at the end of file (stas export script) handler.add_lib(require(\"json_stats\")) Jak napisa\u0107 bibliotek\u0119 nauczy\u0142em si\u0119 patrz\u0105c na event_handler.lua i silo-script.lua bo nie znalaz\u0142em dokumentacji opisuj\u0105cej struktury wymaganej przez event_handler . Interesuj\u0105ce dla mnie jest okresowe odpalanie funkcji eksportu, wi\u0119c podpi\u0105\u0142em si\u0119 pod funkcj\u0119 on_nth_tick . Wszystkie klasy i funkcje obczaja\u0142em w dokumentacji . -- json_stats.lua -- unique name that will be added to json and also defines subdirectory for json files local json_stats_uid = \"homelab-vanilla\" -- log stats to file - called on inverval local function log_stats() -- get ticks from start the game local ticks_played = game.ticks_played -- prepare local variables local forces = {} local stats = { [\"json_stats_uid\"] = json_stats_uid, [\"ticks_played\"] = ticks_played, [\"forces\"] = forces } -- iterate through all forces for _, force in pairs(game.forces) do -- get production statistics local production = force.item_production_statistics local consumption = force.fluid_production_statistics -- get production and consumption values local force_stats = { name = force.name, item_production = production.input_counts, item_consumption = production.output_counts, fluid_production = consumption.input_counts, fluid_consumption = consumption.output_counts } -- assigne force stats under force name forces[force.name] = force_stats end -- write file to folder (./script-output) local stats_file_name = json_stats_uid .. \"/\" .. ticks_played .. \".json\" -- last param makes json save only on server -- remove it and file will be saved also on all clients game.write_file(stats_file_name, game.table_to_json(stats) .. \"\\n\", false, 0) end -- tick handler local function on_log_stats(event) log_stats() end -- script object local json_stats = {} -- register tick handlers json_stats.on_nth_tick = { [600] = on_log_stats } -- return script object return json_stats \u017beby doda\u0107 eksport, \u015bci\u0105gn\u0105\u0142em sejwa z serwera, rozpakowa\u0142em plik, zmodyfikowa\u0142em control.lua , doda\u0142em json_stats.lua i spakowa\u0142em ZIP'a ponownie. Restart serwera z nowym sejwem da\u0142 prawid\u0142owy efekt, na serwerku w katalogu ./script-output zacze\u0142y si\u0119 pojawia\u0107 pliki JSON (trzeba si\u0119 pod\u0142\u0105czy\u0107 i odpauzowa\u0107 gr\u0119, \u017ceby sz\u0142y ticki). Co wa\u017cne do serwera nadal mog\u0142em si\u0119 pod\u0142\u0105czy\u0107 ze Switcha :) Czytacz statystyk Wybra\u0142em opcj\u0119 z zapisem do nowych plik\u00f3w per tick i odczytem przez Filebeat'a, jako \u017ce znam troch\u0119 stack Elastica. Statystyki b\u0119d\u0105 odczytywane przez Filebeat i przesy\u0142ane do Logstash'a . Tam nast\u0105pi wst\u0119pna transformacja danych i przes\u0142anie dalej do Elasticsearch . Serwer Factorio stoi na Debianie i instalacja Filebeat'a posz\u0142a z pakietu zgodnie z instrukcj\u0105 na stronie elastica . Konfiguracja Filebeat'a ustawia czytanie z plik\u00f3w json i tymczasowo dump do konsoli. $ mcedit /etc/filebeat/filebeat.yml # filebeat.yml filebeat.inputs: - type: log paths: - /opt/factorio/script-output/map01/*.json json: keys_under_root: true fields_under_root: true close_inactive: 5m tags: [\"map01\"] index: \"factorio-%{+yyyyMMdd}\" output.console: pretty: true Uruchomienie Filebeat'a. $ systemctl enable filebeat $ systemctl start filebeat $ systemctl status filebeat $ journalctl -u filebeat -f Nast\u0119pnym krokiem jest czyszczenie starych plik\u00f3w. Doda\u0142em plik factorio_stats do /etc/cron.d/ co daje bufor na 10 minut. * * * * * root LC_ALL=C find /opt/factorio/script-output/map01/ -name '*.json' -type f -mmin +9 -delete Po testach i upewnieniu si\u0119, \u017ce w logach Filebeat'a wida\u0107 nowe pliki stats\u00f3w oraz, \u017ce skrypt czyszcz\u0105cy spe\u0142nia swoje zadanie przeszed\u0142em do instalacji Logstash'a. Note FIXME: add logstash install Baza statystyk Note FIXME: add elasticsearch install Wizualizacja statystyk Note FIXME: add kibana install Bonus: fusepy Wygenerowane przez ChatGPT. Nietestowane. Jako ciekawostka. $ sudo apt-get update $ sudo apt-get install fuse $ pip install fusepy requests # file_emulator.py import os import stat import errno import threading import requests from fuse import FUSE, Operations from time import sleep class FileEmulator(Operations): def __init__(self): self.file_content = b'' self.lock = threading.Lock() self.old_content = b'' def getattr(self, path, fh=None): if path == '/file.bin': st = { 'st_mode': (stat.S_IFREG | 0o666), 'st_nlink': 1, 'st_size': len(self.file_content), 'st_ctime': 0, 'st_mtime': 0, 'st_atime': 0, } return st else: raise OSError(errno.ENOENT, os.strerror(errno.ENOENT)) def open(self, path, flags): if path == '/file.bin': return 0 else: raise OSError(errno.ENOENT, os.strerror(errno.ENOENT)) def read(self, path, size, offset, fh): if path == '/file.bin': with self.lock: return self.file_content[offset:offset + size] else: raise OSError(errno.ENOENT, os.strerror(errno.ENOENT)) def write(self, path, data, offset, fh): if path == '/file.bin': with self.lock: self.file_content = self.file_content[:offset] + data + self.file_content[offset + len(data):] return len(data) else: raise OSError(errno.ENOENT, os.strerror(errno.ENOENT)) def truncate(self, path, length, fh=None): if path == '/file.bin': with self.lock: self.file_content = self.file_content[:length] return 0 else: raise OSError(errno.ENOENT, os.strerror(errno.ENOENT)) def create(self, path, mode, fi=None): if path == '/file.bin': with self.lock: self.file_content = b'' return 0 else: raise OSError(errno.ENOENT, os.strerror(errno.ENOENT)) def unlink(self, path): if path == '/file.bin': with self.lock: self.file_content = b'' return 0 else: raise OSError(errno.ENOENT, os.strerror(errno.ENOENT)) def watch_file_content(emulator): while True: sleep(1) # Check every second with emulator.lock: if emulator.file_content != emulator.old_content: new_content = emulator.file_content[len(emulator.old_content):] lines = new_content.split(b'\\n') for line in lines[:-1]: # All lines except the last (possibly incomplete) one send_post_request(line) if new_content.endswith(b'\\n'): send_post_request(lines[-1]) emulator.old_content = emulator.file_content else: emulator.old_content += new_content def send_post_request(line): url = \"http://localhost/stats/factorio\" try: response = requests.post(url, data=line) print(f\"Sent POST request with line: {line.decode('utf-8')} - Response: {response.status_code}\") except Exception as e: print(f\"Failed to send POST request: {e}\") if __name__ == '__main__': mountpoint = '/opt/fuse' emulator = FileEmulator() # Start the watcher thread watcher_thread = threading.Thread(target=watch_file_content, args=(emulator,)) watcher_thread.daemon = True watcher_thread.start() # Mount the FUSE filesystem FUSE(emulator, mountpoint, nothreads=True, foreground=True) sudo python file_emulator.py Linki https://en.wikipedia.org/wiki/Filesystem_in_Userspace https://stackoverflow.com/questions/48402218/fuse-inside-docker https://github.com/s3fs-fuse/s3fs-fuse/issues/1046 https://www.linuxbabe.com/command-line/create-ramdisk-linux https://lua-api.factorio.com/latest/classes/LuaGameScript.html#write_file https://hub.docker.com/_/elasticsearch https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-overview.html https://www.elastic.co/guide/en/logstash/current/introduction.html https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html","title":"2024.05.17 - Factorio Stats"},{"location":"2024-05-17-factorio-stats/#20240517-factorio-stats","text":"","title":"2024.05.17 - Factorio Stats"},{"location":"2024-05-17-factorio-stats/#intro","text":"Wpad\u0142 pomys\u0142, \u017ceby wyci\u0105gn\u0105\u0107 statystyki Factorio do zewn\u0119trznego wizualizatora. Wymagania s\u0105 do\u015b\u0107 proste: eksport danych do JSON'a, najlepiej aby NIE wymaga\u0142 MOD'a do gry (mo\u017cna b\u0119dzie si\u0119 \u0142\u0105czy\u0107 do serwera ze Switcha, kt\u00f3ry mod\u00f3w nie obs\u0142uguje), eksport danych do ElasticStacka (logstash jako transformator danych, elasticsearch jako baza danych), wizualizacja Kibana albo Grafana. Z zajawk\u0105 projektu pom\u00f3g\u0142 mi ChatGTP od dzisiaj zwany przeze mnie pieszczotliwie Junior . By\u0142o kilka pr\u00f3b odczytu statystyk, co rzutowa\u0142o na ko\u0144cowy kszta\u0142t skryptu. Pomys\u0142y, kt\u00f3re by\u0142y testowane: zapis do jednego pliku, logrotate i Filebeat/czytacz_w_pytongu emulacja pliku przez skrypt w pytongu z wykorzystaniem fusepy ( Filesystem in USErspace - ciekawe rozwi\u0105zanie - nadal rozwa\u017cam testy) zapis do nowych plik\u00f3w (per tick), odczyt przez Filebeat'a, skrypt sprz\u0105taj\u0105cy (bufor na pliki - docelowo wrzuca\u0107 na tmpfs)","title":"Intro"},{"location":"2024-05-17-factorio-stats/#skrypt-statystyk-dla-factorio","text":"Forma eksportu danych jest ograniczona przez mo\u017cliwo\u015bci LUA w Factorio. W sumie jedynym prostym sposobem jest utworzenie drzewka danych i eksport do pliku w formacie JSON. Aktualnie skrypt jest wstrzykni\u0119ty w istniej\u0105cego sejwa (mo\u017cna to przerobi\u0107 na Scenario ale nie bawi\u0142em si\u0119 tym jeszcze, wi\u0119c nie wiem jak to zrobi\u0107). Pr\u00f3bowa\u0142em z r\u00f3\u017cnymi formami skryptu i najbardziej mi odpowiada forma biblioteki. \u0141adowanie biblioteki nale\u017cy wprowadzi\u0107 do pliku control.lua . -- control.lua -- orginal savefile contents local handler = require(\"event_handler\") handler.add_lib(require(\"freeplay\")) handler.add_lib(require(\"silo-script\")) -- add at the end of file (stas export script) handler.add_lib(require(\"json_stats\")) Jak napisa\u0107 bibliotek\u0119 nauczy\u0142em si\u0119 patrz\u0105c na event_handler.lua i silo-script.lua bo nie znalaz\u0142em dokumentacji opisuj\u0105cej struktury wymaganej przez event_handler . Interesuj\u0105ce dla mnie jest okresowe odpalanie funkcji eksportu, wi\u0119c podpi\u0105\u0142em si\u0119 pod funkcj\u0119 on_nth_tick . Wszystkie klasy i funkcje obczaja\u0142em w dokumentacji . -- json_stats.lua -- unique name that will be added to json and also defines subdirectory for json files local json_stats_uid = \"homelab-vanilla\" -- log stats to file - called on inverval local function log_stats() -- get ticks from start the game local ticks_played = game.ticks_played -- prepare local variables local forces = {} local stats = { [\"json_stats_uid\"] = json_stats_uid, [\"ticks_played\"] = ticks_played, [\"forces\"] = forces } -- iterate through all forces for _, force in pairs(game.forces) do -- get production statistics local production = force.item_production_statistics local consumption = force.fluid_production_statistics -- get production and consumption values local force_stats = { name = force.name, item_production = production.input_counts, item_consumption = production.output_counts, fluid_production = consumption.input_counts, fluid_consumption = consumption.output_counts } -- assigne force stats under force name forces[force.name] = force_stats end -- write file to folder (./script-output) local stats_file_name = json_stats_uid .. \"/\" .. ticks_played .. \".json\" -- last param makes json save only on server -- remove it and file will be saved also on all clients game.write_file(stats_file_name, game.table_to_json(stats) .. \"\\n\", false, 0) end -- tick handler local function on_log_stats(event) log_stats() end -- script object local json_stats = {} -- register tick handlers json_stats.on_nth_tick = { [600] = on_log_stats } -- return script object return json_stats \u017beby doda\u0107 eksport, \u015bci\u0105gn\u0105\u0142em sejwa z serwera, rozpakowa\u0142em plik, zmodyfikowa\u0142em control.lua , doda\u0142em json_stats.lua i spakowa\u0142em ZIP'a ponownie. Restart serwera z nowym sejwem da\u0142 prawid\u0142owy efekt, na serwerku w katalogu ./script-output zacze\u0142y si\u0119 pojawia\u0107 pliki JSON (trzeba si\u0119 pod\u0142\u0105czy\u0107 i odpauzowa\u0107 gr\u0119, \u017ceby sz\u0142y ticki). Co wa\u017cne do serwera nadal mog\u0142em si\u0119 pod\u0142\u0105czy\u0107 ze Switcha :)","title":"Skrypt statystyk dla Factorio"},{"location":"2024-05-17-factorio-stats/#czytacz-statystyk","text":"Wybra\u0142em opcj\u0119 z zapisem do nowych plik\u00f3w per tick i odczytem przez Filebeat'a, jako \u017ce znam troch\u0119 stack Elastica. Statystyki b\u0119d\u0105 odczytywane przez Filebeat i przesy\u0142ane do Logstash'a . Tam nast\u0105pi wst\u0119pna transformacja danych i przes\u0142anie dalej do Elasticsearch . Serwer Factorio stoi na Debianie i instalacja Filebeat'a posz\u0142a z pakietu zgodnie z instrukcj\u0105 na stronie elastica . Konfiguracja Filebeat'a ustawia czytanie z plik\u00f3w json i tymczasowo dump do konsoli. $ mcedit /etc/filebeat/filebeat.yml # filebeat.yml filebeat.inputs: - type: log paths: - /opt/factorio/script-output/map01/*.json json: keys_under_root: true fields_under_root: true close_inactive: 5m tags: [\"map01\"] index: \"factorio-%{+yyyyMMdd}\" output.console: pretty: true Uruchomienie Filebeat'a. $ systemctl enable filebeat $ systemctl start filebeat $ systemctl status filebeat $ journalctl -u filebeat -f Nast\u0119pnym krokiem jest czyszczenie starych plik\u00f3w. Doda\u0142em plik factorio_stats do /etc/cron.d/ co daje bufor na 10 minut. * * * * * root LC_ALL=C find /opt/factorio/script-output/map01/ -name '*.json' -type f -mmin +9 -delete Po testach i upewnieniu si\u0119, \u017ce w logach Filebeat'a wida\u0107 nowe pliki stats\u00f3w oraz, \u017ce skrypt czyszcz\u0105cy spe\u0142nia swoje zadanie przeszed\u0142em do instalacji Logstash'a. Note FIXME: add logstash install","title":"Czytacz statystyk"},{"location":"2024-05-17-factorio-stats/#baza-statystyk","text":"Note FIXME: add elasticsearch install","title":"Baza statystyk"},{"location":"2024-05-17-factorio-stats/#wizualizacja-statystyk","text":"Note FIXME: add kibana install","title":"Wizualizacja statystyk"},{"location":"2024-05-17-factorio-stats/#bonus-fusepy","text":"Wygenerowane przez ChatGPT. Nietestowane. Jako ciekawostka. $ sudo apt-get update $ sudo apt-get install fuse $ pip install fusepy requests # file_emulator.py import os import stat import errno import threading import requests from fuse import FUSE, Operations from time import sleep class FileEmulator(Operations): def __init__(self): self.file_content = b'' self.lock = threading.Lock() self.old_content = b'' def getattr(self, path, fh=None): if path == '/file.bin': st = { 'st_mode': (stat.S_IFREG | 0o666), 'st_nlink': 1, 'st_size': len(self.file_content), 'st_ctime': 0, 'st_mtime': 0, 'st_atime': 0, } return st else: raise OSError(errno.ENOENT, os.strerror(errno.ENOENT)) def open(self, path, flags): if path == '/file.bin': return 0 else: raise OSError(errno.ENOENT, os.strerror(errno.ENOENT)) def read(self, path, size, offset, fh): if path == '/file.bin': with self.lock: return self.file_content[offset:offset + size] else: raise OSError(errno.ENOENT, os.strerror(errno.ENOENT)) def write(self, path, data, offset, fh): if path == '/file.bin': with self.lock: self.file_content = self.file_content[:offset] + data + self.file_content[offset + len(data):] return len(data) else: raise OSError(errno.ENOENT, os.strerror(errno.ENOENT)) def truncate(self, path, length, fh=None): if path == '/file.bin': with self.lock: self.file_content = self.file_content[:length] return 0 else: raise OSError(errno.ENOENT, os.strerror(errno.ENOENT)) def create(self, path, mode, fi=None): if path == '/file.bin': with self.lock: self.file_content = b'' return 0 else: raise OSError(errno.ENOENT, os.strerror(errno.ENOENT)) def unlink(self, path): if path == '/file.bin': with self.lock: self.file_content = b'' return 0 else: raise OSError(errno.ENOENT, os.strerror(errno.ENOENT)) def watch_file_content(emulator): while True: sleep(1) # Check every second with emulator.lock: if emulator.file_content != emulator.old_content: new_content = emulator.file_content[len(emulator.old_content):] lines = new_content.split(b'\\n') for line in lines[:-1]: # All lines except the last (possibly incomplete) one send_post_request(line) if new_content.endswith(b'\\n'): send_post_request(lines[-1]) emulator.old_content = emulator.file_content else: emulator.old_content += new_content def send_post_request(line): url = \"http://localhost/stats/factorio\" try: response = requests.post(url, data=line) print(f\"Sent POST request with line: {line.decode('utf-8')} - Response: {response.status_code}\") except Exception as e: print(f\"Failed to send POST request: {e}\") if __name__ == '__main__': mountpoint = '/opt/fuse' emulator = FileEmulator() # Start the watcher thread watcher_thread = threading.Thread(target=watch_file_content, args=(emulator,)) watcher_thread.daemon = True watcher_thread.start() # Mount the FUSE filesystem FUSE(emulator, mountpoint, nothreads=True, foreground=True) sudo python file_emulator.py","title":"Bonus: fusepy"},{"location":"2024-05-17-factorio-stats/#linki","text":"https://en.wikipedia.org/wiki/Filesystem_in_Userspace https://stackoverflow.com/questions/48402218/fuse-inside-docker https://github.com/s3fs-fuse/s3fs-fuse/issues/1046 https://www.linuxbabe.com/command-line/create-ramdisk-linux https://lua-api.factorio.com/latest/classes/LuaGameScript.html#write_file https://hub.docker.com/_/elasticsearch https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-overview.html https://www.elastic.co/guide/en/logstash/current/introduction.html https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html","title":"Linki"},{"location":"2025-05-09-synology-truenas/","text":"2025.05.09 - Synology DS414 \u2192 TrueNAS Intro Po ostatnich ruchach Synology w zakresie obs\u0142ugi dysk\u00f3w w modelach Plus i przechodzenia na model biznesowy doszed\u0142em do wniosku, \u017ce dam szans\u0119 NAS 'owi DIY. Wyb\u00f3r pad\u0142 na TrueNAS Scale . Celem jest zrobienie z istniej\u0105cych komponent\u00f3w NAS 'a do backupu istniej\u0105cej jednostki Syno DS414 . Przygotowanie teoretyczne Po obejrzeniu kilku(nastu) filmik\u00f3w o TrueNAS i ZFS wybra\u0142em nast\u0119puj\u0105c\u0105 konfiguracj\u0119 i podzia\u0142 dysk\u00f3w: ASRock J3355M 16GB RAM vdev1 - 3x WD Red 3TB - RAIDZ1 vdev2 - 3x WD Red 2TB - RAIDZ1 zasilacz SFX 450W karta PCIe x1 na 4x SATA Je\u015bli dobrze zrozumia\u0142em to powinno to da\u0107 2x IOPSy (w uproszczeniu ka\u017cdy VDEV ma IOPSy pojedynczego dysku) i odporno\u015b\u0107 na awari\u0119 dw\u00f3ch dysk\u00f3w w dw\u00f3ch grupach. Oczywi\u015bcie je\u015bli strzel\u0105 dwa dysku w jednym VDEV 'ie to papa dane :) Gdzie to zmie\u015bci\u0107? Po zebraniu grat\u00f3w przysz\u0142a kolej na wa\u017cne pytanie: gdzie to wszystko zmie\u015bci\u0107? Nie chcia\u0142em tworzy\u0107 kolejnego klockowantego PC'a, tylko co\u015b co w minimalnym stopniu przypomina\u0142oby domowego NAS 'a. Wymagania by\u0142y nast\u0119puj\u0105ce: obudowa na dyski modu\u0142owa , \u017ceby mo\u017cna by\u0142o w przysz\u0142o\u015bci doda\u0107 ich wi\u0119cej (na pocz\u0105tek 6 HDD) wykorzystanie standardowej p\u0142yty micro-atx opcjonalnie monta\u017c w racku 10\" lub 19\" opcjonalnie umie\u015bci\u0107 zasilacz SFX obok dysk\u00f3w \u017ceby zmie\u015bci\u0107 si\u0119 w racku 10\" W trakcie przeszukiwania internetu oraz prototypowania w\u0142asnej obudowy do druku 3D trafi\u0142em na pi\u0119kny projekt DIY :) 3D Printed NAS https://www.youtube.com/watch?v=NXIu-B52WPU Ca\u0142y projekt dost\u0119pny jest na Githubie https://github.com/sb-ocr/3d-printed-nas . Zdecydowa\u0142em si\u0119 na pewno wykorzysta\u0107 monta\u017c dysk\u00f3w, oraz mo\u017ce monta\u017c na p\u0142yt\u0119 g\u0142\u00f3wn\u0105. Reszta obudowy b\u0119dzie prosta do zaprojektowania wi\u0119c ogarn\u0119 to w Fusion 360 . Drukowanie Obudowa od Salim'a nie nadaje si\u0119 do u\u017cytku przez mnie 1:1. Po pierwsze ca\u0142a elektronika jest inna ( micro-ATX zamiast ZimaBoard ), a po drugie nie mam tak du\u017cej drukarki \u017ceby cz\u0119\u015bci drukowa\u0107 w jednym kawa\u0142ku. Prusa Mini ma pole wydruku 18x18cm, Bambu 25x25cm. Niekt\u00f3re cz\u0119\u015bci uda\u0142o si\u0119 upchn\u0105\u0107, ale reszta musia\u0142a by\u0107 poci\u0119ta na mniejsze kawa\u0142ki. Najwi\u0119kszym problemem jest drive-bay - tam gdzie zamontowana jest przej\u015bci\u00f3wka do SATA - na ni\u0105 dzia\u0142aj\u0105 si\u0142y wpinania i wyrywania dysku. Na szcz\u0119\u015bcie z pomoc\u0105 przysz\u0142o Allegro i wspania\u0142a, chi\u0144ska zgrzewarka do plastiku :) Zgrzewarka do plastiku Po wydrukowaniu pierwszych element\u00f3w, efekt by\u0142 zadowalaj\u0105cy. Drive-bay Drive-bay Sanki 1/2 Drive-bay druk Inserty M3 Backup Syno do TrueNAS Backup b\u0119dzie z wykorzystaniem rsync inicjowany po stronie TrueNAS . Konfiguracja Synology Wszystkie operacje wykonywane by\u0142y na DSM 7.1. Najpierw trzeba w\u0142\u0105czy\u0107 rsync po stronie Syno. Panel sterowania \u2192 Us\u0142ugi plik\u00f3w \u2192 rsync W\u0142aczenie us\u0142ugi rsync Nast\u0119pnie trzeba utworzy\u0107 u\u017cytkownika z prawami tylko do odczytu do backupowanych zasob\u00f3w. Tworzenie u\u017cytkownika Tworzenie u\u017cytkownika Ustawienie uprawnie\u0144 do plik\u00f3w Ustawienie uprawnie\u0144 do aplikacji Nast\u0119pnie trzeba si\u0119 zalogowa\u0107 via ssh na Synology i doda\u0107 klucz dla u\u017cytkownika truenas oraz w\u0142\u0105czy\u0107 logowanie po kluczu w pliku /etc/ssh/sshd_config PubkeyAuthentication yes Test rsync Teraz mo\u017cna przetestowa\u0107 dzia\u0142anie rsync 'a z komputera. Wygenerowa\u0142em z PuttyGen'a nowy klucz Ed25519 i doda\u0142em authorized_keys po stronie Syno . Nast\u0119pnie w konfiguracji klienta .ssh/config doda\u0142em nast\u0119puj\u0105ce wpisy, \u017ceby nie musiec podawa\u0107 ich za ka\u017cdym razem: Host ds414 IdentityFile ~/.ssh/truenas # moje Syno bez dodania algorytmu nie znajdowa\u0142o wsp\u00f3lnego j\u0119zyka PubkeyAcceptedAlgorithms +ssh-ed25519 User truenas Uworzy\u0142em testowy plik z filtrami - @eaDir + /my_files/ + /my_files/** - * Nast\u0119pnie wykona\u0142em kilka test\u00f3w z r\u00f3\u017cnymi parametrami. Docelowo b\u0119dzie to chyba wygl\u0105da\u0107 tak: $ rsync -e \"ssh -p 2222\" -avPW --delete --no-z -f '. /tmp/.rsync-filter' truenas@synology:/volume1/ /tmp/volume1/ receiving incremental file list ./ sent 90 bytes received 252 bytes 228.00 bytes/sec total size is 59,135,637 speedup is 172,911.22 (DRY RUN) Konfiguracja TrueNAS Testowo pod\u0142\u0105czy\u0142em jeden dysk i utworzy\u0142em data-set test-dataset Nast\u0119pnie w panelu Credentials -> Backup credentials wygenerowa\u0142em nowy klucz dla po\u0142\u0105czenia do Syno i doda\u0142em go na DS414 dla u\u017cytkownika truenas Oraz skonfigurowa\u0142em SSH Connection Przysz\u0142a pora na skonfigurowanie backupu. W panelu Data Protection -> Rsync Tasks doda\u0142em nowego job'a. Najwa\u017cniejsze ustawienia to \u015bcie\u017cki oraz kierunek po\u0142\u0105czenia na Pull Parametry oraz harmonogram na pewno b\u0119d\u0105 si\u0119 zmienia\u0107 z czasem, ale na pocz\u0105tek da\u0142em co\u015b takiego Po zalogowaniu si\u0119 na TrueNAS via SSH utworzy\u0142em wymagane katalogi na test-dataset i pu\u015bci\u0142em joba z r\u0119ki. Job zacz\u0105\u0142 si\u0119 kr\u0119ci\u0107, a na dysku pojawia\u0107 pliki. Linki https://www.theverge.com/news/652364/synology-nas-third-party-hard-drive-restrictions https://www.blackvoid.club/new-2025-synology-disk-compatibility-policy/ https://www.truenas.com/truenas-scale/ https://www.youtube.com/watch?v=_aACgNm8UCw https://www.youtube.com/watch?v=-AnkHc7N0zM https://www.youtube.com/watch?v=0d4_nvdZdOc https://www.youtube.com/watch?v=M4DLChRXJog https://www.youtube.com/watch?v=NXIu-B52WPU https://github.com/sb-ocr/3d-printed-nas https://www.silica.io/using-ssh-key-authentification-on-a-synology-nas-for-remote-rsync-backups/ https://stackoverflow.com/questions/73795935/sign-and-send-pubkey-no-mutual-signature-supported","title":"2025.05.09 - Synology DS414 \u2192 TrueNAS"},{"location":"2025-05-09-synology-truenas/#20250509-synology-ds414-truenas","text":"","title":"2025.05.09 - Synology DS414 \u2192 TrueNAS"},{"location":"2025-05-09-synology-truenas/#intro","text":"Po ostatnich ruchach Synology w zakresie obs\u0142ugi dysk\u00f3w w modelach Plus i przechodzenia na model biznesowy doszed\u0142em do wniosku, \u017ce dam szans\u0119 NAS 'owi DIY. Wyb\u00f3r pad\u0142 na TrueNAS Scale . Celem jest zrobienie z istniej\u0105cych komponent\u00f3w NAS 'a do backupu istniej\u0105cej jednostki Syno DS414 .","title":"Intro"},{"location":"2025-05-09-synology-truenas/#przygotowanie-teoretyczne","text":"Po obejrzeniu kilku(nastu) filmik\u00f3w o TrueNAS i ZFS wybra\u0142em nast\u0119puj\u0105c\u0105 konfiguracj\u0119 i podzia\u0142 dysk\u00f3w: ASRock J3355M 16GB RAM vdev1 - 3x WD Red 3TB - RAIDZ1 vdev2 - 3x WD Red 2TB - RAIDZ1 zasilacz SFX 450W karta PCIe x1 na 4x SATA Je\u015bli dobrze zrozumia\u0142em to powinno to da\u0107 2x IOPSy (w uproszczeniu ka\u017cdy VDEV ma IOPSy pojedynczego dysku) i odporno\u015b\u0107 na awari\u0119 dw\u00f3ch dysk\u00f3w w dw\u00f3ch grupach. Oczywi\u015bcie je\u015bli strzel\u0105 dwa dysku w jednym VDEV 'ie to papa dane :)","title":"Przygotowanie teoretyczne"},{"location":"2025-05-09-synology-truenas/#gdzie-to-zmiescic","text":"Po zebraniu grat\u00f3w przysz\u0142a kolej na wa\u017cne pytanie: gdzie to wszystko zmie\u015bci\u0107? Nie chcia\u0142em tworzy\u0107 kolejnego klockowantego PC'a, tylko co\u015b co w minimalnym stopniu przypomina\u0142oby domowego NAS 'a. Wymagania by\u0142y nast\u0119puj\u0105ce: obudowa na dyski modu\u0142owa , \u017ceby mo\u017cna by\u0142o w przysz\u0142o\u015bci doda\u0107 ich wi\u0119cej (na pocz\u0105tek 6 HDD) wykorzystanie standardowej p\u0142yty micro-atx opcjonalnie monta\u017c w racku 10\" lub 19\" opcjonalnie umie\u015bci\u0107 zasilacz SFX obok dysk\u00f3w \u017ceby zmie\u015bci\u0107 si\u0119 w racku 10\" W trakcie przeszukiwania internetu oraz prototypowania w\u0142asnej obudowy do druku 3D trafi\u0142em na pi\u0119kny projekt DIY :) 3D Printed NAS https://www.youtube.com/watch?v=NXIu-B52WPU Ca\u0142y projekt dost\u0119pny jest na Githubie https://github.com/sb-ocr/3d-printed-nas . Zdecydowa\u0142em si\u0119 na pewno wykorzysta\u0107 monta\u017c dysk\u00f3w, oraz mo\u017ce monta\u017c na p\u0142yt\u0119 g\u0142\u00f3wn\u0105. Reszta obudowy b\u0119dzie prosta do zaprojektowania wi\u0119c ogarn\u0119 to w Fusion 360 .","title":"Gdzie to zmie\u015bci\u0107?"},{"location":"2025-05-09-synology-truenas/#drukowanie","text":"Obudowa od Salim'a nie nadaje si\u0119 do u\u017cytku przez mnie 1:1. Po pierwsze ca\u0142a elektronika jest inna ( micro-ATX zamiast ZimaBoard ), a po drugie nie mam tak du\u017cej drukarki \u017ceby cz\u0119\u015bci drukowa\u0107 w jednym kawa\u0142ku. Prusa Mini ma pole wydruku 18x18cm, Bambu 25x25cm. Niekt\u00f3re cz\u0119\u015bci uda\u0142o si\u0119 upchn\u0105\u0107, ale reszta musia\u0142a by\u0107 poci\u0119ta na mniejsze kawa\u0142ki. Najwi\u0119kszym problemem jest drive-bay - tam gdzie zamontowana jest przej\u015bci\u00f3wka do SATA - na ni\u0105 dzia\u0142aj\u0105 si\u0142y wpinania i wyrywania dysku. Na szcz\u0119\u015bcie z pomoc\u0105 przysz\u0142o Allegro i wspania\u0142a, chi\u0144ska zgrzewarka do plastiku :) Zgrzewarka do plastiku Po wydrukowaniu pierwszych element\u00f3w, efekt by\u0142 zadowalaj\u0105cy. Drive-bay Drive-bay Sanki 1/2 Drive-bay druk Inserty M3","title":"Drukowanie"},{"location":"2025-05-09-synology-truenas/#backup-syno-do-truenas","text":"Backup b\u0119dzie z wykorzystaniem rsync inicjowany po stronie TrueNAS .","title":"Backup Syno do TrueNAS"},{"location":"2025-05-09-synology-truenas/#konfiguracja-synology","text":"Wszystkie operacje wykonywane by\u0142y na DSM 7.1. Najpierw trzeba w\u0142\u0105czy\u0107 rsync po stronie Syno. Panel sterowania \u2192 Us\u0142ugi plik\u00f3w \u2192 rsync W\u0142aczenie us\u0142ugi rsync Nast\u0119pnie trzeba utworzy\u0107 u\u017cytkownika z prawami tylko do odczytu do backupowanych zasob\u00f3w. Tworzenie u\u017cytkownika Tworzenie u\u017cytkownika Ustawienie uprawnie\u0144 do plik\u00f3w Ustawienie uprawnie\u0144 do aplikacji Nast\u0119pnie trzeba si\u0119 zalogowa\u0107 via ssh na Synology i doda\u0107 klucz dla u\u017cytkownika truenas oraz w\u0142\u0105czy\u0107 logowanie po kluczu w pliku /etc/ssh/sshd_config PubkeyAuthentication yes","title":"Konfiguracja Synology"},{"location":"2025-05-09-synology-truenas/#test-rsync","text":"Teraz mo\u017cna przetestowa\u0107 dzia\u0142anie rsync 'a z komputera. Wygenerowa\u0142em z PuttyGen'a nowy klucz Ed25519 i doda\u0142em authorized_keys po stronie Syno . Nast\u0119pnie w konfiguracji klienta .ssh/config doda\u0142em nast\u0119puj\u0105ce wpisy, \u017ceby nie musiec podawa\u0107 ich za ka\u017cdym razem: Host ds414 IdentityFile ~/.ssh/truenas # moje Syno bez dodania algorytmu nie znajdowa\u0142o wsp\u00f3lnego j\u0119zyka PubkeyAcceptedAlgorithms +ssh-ed25519 User truenas Uworzy\u0142em testowy plik z filtrami - @eaDir + /my_files/ + /my_files/** - * Nast\u0119pnie wykona\u0142em kilka test\u00f3w z r\u00f3\u017cnymi parametrami. Docelowo b\u0119dzie to chyba wygl\u0105da\u0107 tak: $ rsync -e \"ssh -p 2222\" -avPW --delete --no-z -f '. /tmp/.rsync-filter' truenas@synology:/volume1/ /tmp/volume1/ receiving incremental file list ./ sent 90 bytes received 252 bytes 228.00 bytes/sec total size is 59,135,637 speedup is 172,911.22 (DRY RUN)","title":"Test rsync"},{"location":"2025-05-09-synology-truenas/#konfiguracja-truenas","text":"Testowo pod\u0142\u0105czy\u0142em jeden dysk i utworzy\u0142em data-set test-dataset Nast\u0119pnie w panelu Credentials -> Backup credentials wygenerowa\u0142em nowy klucz dla po\u0142\u0105czenia do Syno i doda\u0142em go na DS414 dla u\u017cytkownika truenas Oraz skonfigurowa\u0142em SSH Connection Przysz\u0142a pora na skonfigurowanie backupu. W panelu Data Protection -> Rsync Tasks doda\u0142em nowego job'a. Najwa\u017cniejsze ustawienia to \u015bcie\u017cki oraz kierunek po\u0142\u0105czenia na Pull Parametry oraz harmonogram na pewno b\u0119d\u0105 si\u0119 zmienia\u0107 z czasem, ale na pocz\u0105tek da\u0142em co\u015b takiego Po zalogowaniu si\u0119 na TrueNAS via SSH utworzy\u0142em wymagane katalogi na test-dataset i pu\u015bci\u0142em joba z r\u0119ki. Job zacz\u0105\u0142 si\u0119 kr\u0119ci\u0107, a na dysku pojawia\u0107 pliki.","title":"Konfiguracja TrueNAS"},{"location":"2025-05-09-synology-truenas/#linki","text":"https://www.theverge.com/news/652364/synology-nas-third-party-hard-drive-restrictions https://www.blackvoid.club/new-2025-synology-disk-compatibility-policy/ https://www.truenas.com/truenas-scale/ https://www.youtube.com/watch?v=_aACgNm8UCw https://www.youtube.com/watch?v=-AnkHc7N0zM https://www.youtube.com/watch?v=0d4_nvdZdOc https://www.youtube.com/watch?v=M4DLChRXJog https://www.youtube.com/watch?v=NXIu-B52WPU https://github.com/sb-ocr/3d-printed-nas https://www.silica.io/using-ssh-key-authentification-on-a-synology-nas-for-remote-rsync-backups/ https://stackoverflow.com/questions/73795935/sign-and-send-pubkey-no-mutual-signature-supported","title":"Linki"},{"location":"2025-06-29-proxmox-fix/","text":"2025.06.29 - Proxmox Fix Intro Po ostatnich aktualizacjach Proxmoxa zacz\u0105\u0142 mi si\u0119 resetowa\u0107 Lenovo m920q. Przejrza\u0142em internety i problem jest diagnozowany jako \"marne sterowniki do karty sieciowej Intela\". Drugim problemem to za\u015bmiecanie log\u00f3w wpisami z firewall'a. Jun 29 11:02:36 pve3 pve-firewall[1155]: status update error: ipset_restore_cmdlist: ipset v7.17: Error in line 4: Element cannot be added to the set: it's already added Network - fix z internetu Problem opisany w https://bugzilla.proxmox.com/show_bug.cgi?id=6273 Potencjalne rozwi\u0105zanie to https://forum.proxmox.com/threads/e1000-driver-hang.58284/page-8#post-375919 Dopisa\u0142em do /etc/networking/interfaces post-up dla eno1 . (...) iface eno1 inet manual post-up /usr/bin/logger -p info -t ifup \"Disabling offload for eno1\" && /sbin/ethtool -K eno1 tso off gso off gro off && /usr/bin/logger -p info -t ifup \"Disabled offload of eno1\" (...) Po r\u0119cznym uruchomieniu skrypty w logach wida\u0107 wpis # journalctl -S \"1min ago\" Jun 29 11:03:03 pve3 ifup[167278]: Disabling offload for eno1 Jun 29 11:03:03 pve3 ifup[167280]: Disabled offload of eno1 Teraz patrzymy czy serwer b\u0119dzie bardziej stabilny. Firewall - fix z internetu Problem i rozwi\u0105zanie opisane w https://forum.proxmox.com/threads/proxmox-firewall-doesnt-seem-to-work-and-errors-in-log.128359/#post-561729 Przy konfiguracji firewalla chyba \u017ale poda\u0142em aliasy dla host\u00f3w PVE - mia\u0142y adresy 192.168.2.x/24 zamiast /32. Usuni\u0119cie maski via GUI rozwi\u0105za\u0142o spraw\u0119 i w logach nie ma ju\u017c b\u0142\u0119d\u00f3w. Datacenter -> Firewall -> Alias Firewall config Jun 29 11:07:46 pve3 pvefw-logger[592]: received terminate request (signal) Jun 29 11:07:46 pve3 pvefw-logger[592]: stopping pvefw logger Jun 29 11:07:46 pve3 systemd[1]: Stopping pvefw-logger.service - Proxmox VE firewall logger... Jun 29 11:07:47 pve3 systemd[1]: pvefw-logger.service: Deactivated successfully. Jun 29 11:07:47 pve3 systemd[1]: Stopped pvefw-logger.service - Proxmox VE firewall logger. Jun 29 11:07:47 pve3 systemd[1]: pvefw-logger.service: Consumed 1.316s CPU time. Jun 29 11:07:47 pve3 systemd[1]: Starting pvefw-logger.service - Proxmox VE firewall logger... Jun 29 11:07:47 pve3 pvefw-logger[169286]: starting pvefw logger Jun 29 11:07:47 pve3 systemd[1]: Started pvefw-logger.service - Proxmox VE firewall logger. Jun 29 11:08:16 pve3 pmxcfs[146658]: [status] notice: received log Jun 29 11:08:45 pve3 pmxcfs[146658]: [status] notice: received log Jun 29 11:08:45 pve3 pmxcfs[146658]: [status] notice: received log Jun 29 11:11:13 pve3 pmxcfs[146658]: [status] notice: received log","title":"2025.06.29 - Proxmox Fix"},{"location":"2025-06-29-proxmox-fix/#20250629-proxmox-fix","text":"","title":"2025.06.29 - Proxmox Fix"},{"location":"2025-06-29-proxmox-fix/#intro","text":"Po ostatnich aktualizacjach Proxmoxa zacz\u0105\u0142 mi si\u0119 resetowa\u0107 Lenovo m920q. Przejrza\u0142em internety i problem jest diagnozowany jako \"marne sterowniki do karty sieciowej Intela\". Drugim problemem to za\u015bmiecanie log\u00f3w wpisami z firewall'a. Jun 29 11:02:36 pve3 pve-firewall[1155]: status update error: ipset_restore_cmdlist: ipset v7.17: Error in line 4: Element cannot be added to the set: it's already added","title":"Intro"},{"location":"2025-06-29-proxmox-fix/#network-fix-z-internetu","text":"Problem opisany w https://bugzilla.proxmox.com/show_bug.cgi?id=6273 Potencjalne rozwi\u0105zanie to https://forum.proxmox.com/threads/e1000-driver-hang.58284/page-8#post-375919 Dopisa\u0142em do /etc/networking/interfaces post-up dla eno1 . (...) iface eno1 inet manual post-up /usr/bin/logger -p info -t ifup \"Disabling offload for eno1\" && /sbin/ethtool -K eno1 tso off gso off gro off && /usr/bin/logger -p info -t ifup \"Disabled offload of eno1\" (...) Po r\u0119cznym uruchomieniu skrypty w logach wida\u0107 wpis # journalctl -S \"1min ago\" Jun 29 11:03:03 pve3 ifup[167278]: Disabling offload for eno1 Jun 29 11:03:03 pve3 ifup[167280]: Disabled offload of eno1 Teraz patrzymy czy serwer b\u0119dzie bardziej stabilny.","title":"Network - fix z internetu"},{"location":"2025-06-29-proxmox-fix/#firewall-fix-z-internetu","text":"Problem i rozwi\u0105zanie opisane w https://forum.proxmox.com/threads/proxmox-firewall-doesnt-seem-to-work-and-errors-in-log.128359/#post-561729 Przy konfiguracji firewalla chyba \u017ale poda\u0142em aliasy dla host\u00f3w PVE - mia\u0142y adresy 192.168.2.x/24 zamiast /32. Usuni\u0119cie maski via GUI rozwi\u0105za\u0142o spraw\u0119 i w logach nie ma ju\u017c b\u0142\u0119d\u00f3w. Datacenter -> Firewall -> Alias Firewall config Jun 29 11:07:46 pve3 pvefw-logger[592]: received terminate request (signal) Jun 29 11:07:46 pve3 pvefw-logger[592]: stopping pvefw logger Jun 29 11:07:46 pve3 systemd[1]: Stopping pvefw-logger.service - Proxmox VE firewall logger... Jun 29 11:07:47 pve3 systemd[1]: pvefw-logger.service: Deactivated successfully. Jun 29 11:07:47 pve3 systemd[1]: Stopped pvefw-logger.service - Proxmox VE firewall logger. Jun 29 11:07:47 pve3 systemd[1]: pvefw-logger.service: Consumed 1.316s CPU time. Jun 29 11:07:47 pve3 systemd[1]: Starting pvefw-logger.service - Proxmox VE firewall logger... Jun 29 11:07:47 pve3 pvefw-logger[169286]: starting pvefw logger Jun 29 11:07:47 pve3 systemd[1]: Started pvefw-logger.service - Proxmox VE firewall logger. Jun 29 11:08:16 pve3 pmxcfs[146658]: [status] notice: received log Jun 29 11:08:45 pve3 pmxcfs[146658]: [status] notice: received log Jun 29 11:08:45 pve3 pmxcfs[146658]: [status] notice: received log Jun 29 11:11:13 pve3 pmxcfs[146658]: [status] notice: received log","title":"Firewall - fix z internetu"}]}